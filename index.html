<!DOCTYPE html>
<html lang="es" id="htmlRoot">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star ‚ú¶</title>
    <meta name="description" content="Or√°culo de Tarot y Numerolog√≠a del presente.">
    <!-- World App MiniKit -->
    <!-- World App MiniKit Wrapper (Local Fallback) -->
    <script src="./public/libs/minikit-wrapper.js"></script>
    <!-- i18n Translation Module -->
    <script src="./public/i18n.js"></script>
    <style>
        /* =====================================================
           OR√ÅCULO WHITESUR - PROYECTO 7.41
           Fusi√≥n: Glassmorphism Apple Music Style + Misticismo
        ===================================================== */

        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        :root {
            /* GLASSMORPHISM - Ajustado para fondos din√°micos claros */
            --glass-surface: rgba(255, 255, 255, 0.5);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-blur: 35px;
            --shadow-soft: 0 12px 42px rgba(0, 0, 0, 0.1);
            --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.15);

            /* TIPOGRAF√çA - Ajustada a oscuro para legibilidad sobre cristal claro */
            --text-primary: #1d1d1f;
            --text-secondary: #424245;
            --text-tertiary: rgba(0, 0, 0, 0.5);

            /* ANIMACIONES - Basadas en principios de Apple HIG */
            --ease-smooth: cubic-bezier(0.22, 1, 0.36, 1);
            /* Ease out suave */
            --ease-bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            /* Rebote sutil */
            --ease-natural: cubic-bezier(0.4, 0.0, 0.2, 1);
            /* Material Design */

            /* Variables para colores din√°micos del fondo */
            --color1: #ffffff;
            --color2: #ffffff;
            --color3: #ffffff;
            --color4: #ffffff;

            /* Color de keyword - basado en la paleta de la carta */
            --keyword-color: #FFEB3B;

            /* GYROSCOPE - Variables actualizadas din√°micamente por JavaScript */
            --gyro-x: 0;
            --gyro-y: 0;
            --gyro-z: 0;
            --gyro-hue: 0deg;
        }

        * {
            box-sizing: border-box;
        }

        /* Eliminar outline azul de selecci√≥n (Requerimiento del usuario) */
        *,
        *:focus,
        *:active,
        button:focus,
        button:active,
        a:focus,
        a:active,
        div:focus,
        div:active,
        [tabindex]:focus,
        [tabindex]:active,
        *:focus-visible,
        .card-stage,
        .card-stage:focus,
        .card-stage:active,
        .card-inner,
        .card-inner:focus,
        .card-inner:active {
            outline: none !important;
            box-shadow: none !important;
            -webkit-tap-highlight-color: transparent !important;
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100%;
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-overflow-scrolling: touch;
        }

        /* BLOQUEO DE SCROLL HASTA QUE LA CARTA SE REVELE */
        body.no-scroll {
            overflow: hidden;
            /* Evita el scroll en el body */
            position: fixed;
            /* Previene que se mueva el contenido en iOS */
            width: 100%;
            /* Mantiene el ancho */
        }

        /* ==================== WALLPAPER DIN√ÅMICO ESTILO APPLE MUSIC L√çQUIDO ==================== */
        .wallpaper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            /* Inicia en blanco */
            z-index: -2;
            overflow: hidden;
            /* Contiene las manchas de color */
            transition: background-color 0.8s var(--ease-smooth);
        }

        .wallpaper.active {
            /* Un ligero tinte cuando est√° activo para mejorar el efecto */
            background: #f9f9f9;
        }

        /* Manchas de color (Blobs) */
        .blob {
            position: absolute;
            border-radius: 50%;
            /* El blur intenso crea el efecto l√≠quido/borroso. Ajustado para ser muy fluido. */
            filter: blur(135px);
            opacity: 0;
            /* Transici√≥n suave al aparecer */
            transition: opacity 1.5s ease-in-out;
            width: 65vmax;
            height: 65vmax;
            /* Mejora la mezcla de colores sobre fondo claro */
            mix-blend-mode: multiply;
        }

        .wallpaper.active .blob {
            /* Opacidad ajustada para un efecto sutil */
            opacity: 0.7;
        }

        /* Asignaci√≥n de colores din√°micos y animaciones √∫nicas */
        .blob1 {
            background: var(--color1);
            animation: move1 28s ease-in-out infinite alternate;
        }

        .blob2 {
            background: var(--color2);
            animation: move2 32s ease-in-out infinite alternate;
        }

        .blob3 {
            background: var(--color3);
            animation: move3 38s ease-in-out infinite alternate;
        }

        .blob4 {
            background: var(--color4);
            animation: move4 42s ease-in-out infinite alternate;
        }

        /* Keyframes para movimiento lento y org√°nico */
        @keyframes move1 {
            from {
                transform: translate(-20%, -20%) scale(1) rotate(0deg);
            }

            to {
                transform: translate(30%, 40%) scale(1.4) rotate(360deg);
            }
        }

        @keyframes move2 {
            from {
                transform: translate(50%, -30%) scale(1.2) rotate(0deg);
            }

            to {
                transform: translate(-20%, 60%) scale(0.9) rotate(-360deg);
            }
        }

        @keyframes move3 {
            from {
                transform: translate(70%, 70%) scale(0.9) rotate(0deg);
            }

            to {
                transform: translate(10%, -10%) scale(1.5) rotate(360deg);
            }
        }

        @keyframes move4 {
            from {
                transform: translate(-10%, 80%) scale(1.1) rotate(0deg);
            }

            to {
                transform: translate(60%, -20%) scale(1) rotate(-360deg);
            }
        }

        /* ==================== IRIDESCENT BORDER EFFECTS (iOS 26 Style) ==================== */

        /* Rainbow gradient animation for borders */
        /* Chromatic aberration doesn't need animated gradients */

        /* Base iridescent border effect - CHROMATIC ABERRATION STYLE */
        .iridescent-border {
            position: relative;
            isolation: isolate;
        }

        /* RED CHANNEL - offset right/up slightly */
        .iridescent-border::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: inherit;
            filter: hue-rotate(0deg) blur(0.4px) brightness(1.3);
            mix-blend-mode: screen;
            opacity: 0.7;
            transform: translate(calc(2px + var(--gyro-x) * 0.03px),
                    calc(1px + var(--gyro-y) * 0.03px));
            /* Radial mask: relaxed for more visibility */
            -webkit-mask: radial-gradient(circle at center, transparent 70%, black 100%);
            mask: radial-gradient(circle at center, transparent 70%, black 100%);
            pointer-events: none;
            z-index: -1;

            /* GPU acceleration */
            will-change: transform, filter;
            transform-style: preserve-3d;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        /* GREEN/BLUE CHANNEL - offset left/down slightly */
        .iridescent-border::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: inherit;
            filter: hue-rotate(180deg) blur(0.4px) brightness(1.3);
            mix-blend-mode: screen;
            opacity: 0.6;
            transform: translate(calc(-2px - var(--gyro-x) * 0.03px),
                    calc(-1px - var(--gyro-y) * 0.03px));
            /* Radial mask: relaxed for more visibility */
            -webkit-mask: radial-gradient(circle at center, transparent 70%, black 100%);
            mask: radial-gradient(circle at center, transparent 70%, black 100%);
            pointer-events: none;
            z-index: -1;

            /* GPU acceleration */
            will-change: transform, filter;
            transform-style: preserve-3d;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        /* Hover: increase brightness and intensity even more */
        .iridescent-border:hover::before {
            opacity: 0.9;
            filter: hue-rotate(0deg) blur(0.3px) brightness(1.8);
        }

        .iridescent-border:hover::after {
            opacity: 0.8;
            filter: hue-rotate(180deg) blur(0.3px) brightness(1.8);
        }

        /* Subtle variant for small elements (buttons) */
        .iridescent-border-subtle::before {
            /* Smaller offset for subtle effect */
            transform: translate(calc(0.5px + var(--gyro-x) * 0.01px),
                    calc(0.25px + var(--gyro-y) * 0.01px));
            opacity: 0.2;
            filter: hue-rotate(0deg) blur(0.3px);
            /* Tighter mask for smaller elements */
            -webkit-mask: radial-gradient(circle at center, transparent 85%, black 100%);
            mask: radial-gradient(circle at center, transparent 85%, black 100%);
        }

        .iridescent-border-subtle::after {
            /* Opposite offset */
            transform: translate(calc(-0.5px - var(--gyro-x) * 0.01px),
                    calc(-0.25px - var(--gyro-y) * 0.01px));
            opacity: 0.15;
            filter: hue-rotate(180deg) blur(0.3px);
            /* Tighter mask for smaller elements */
            -webkit-mask: radial-gradient(circle at center, transparent 85%, black 100%);
            mask: radial-gradient(circle at center, transparent 85%, black 100%);
        }

        .iridescent-border-subtle:hover::before {
            opacity: 0.35;
        }

        .iridescent-border-subtle:hover::after {
            opacity: 0.25;
        }


        /* CAPA DE TEXTURA - Efecto "papel antiguo" muy sutil */
        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="4" stitchTiles="stitch"/></filter><rect width="300" height="300" filter="url(%23n)" opacity="0.05"/></svg>');
            opacity: 0.08;
            z-index: -1;
            pointer-events: none;
            mix-blend-mode: overlay;
        }

        /* ==================== INTERFACE PRINCIPAL ==================== */
        .interface {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* MEJORAR CENTRADO VERTICAL PARA MINIMIZAR SCROLL */
            justify-content: center;
            /* Centra verticalmente cuando no hay scroll */
            /* Eliminada min-height: 100vh para evitar espacio innecesario */
            gap: 40px;
            width: 100%;
            max-width: 1400px;
            padding: 40px 20px;
            margin: 0 auto;
        }

        /* Cuando la carta est√° revelada, volver a flex-start para permitir scroll normal */
        .interface.revealed {
            justify-content: flex-start;
        }

        /* ==================== CARTA - ZONA INTERACTIVA ==================== */
        .card-stage {
            perspective: 1800px;
            width: 282px;
            /* Adjusted for 9:16 Aspect Ratio (approx) */
            height: 500px;
            cursor: pointer;
            z-index: 10;
            margin-top: 20px;
            flex-shrink: 0;
            transform-style: preserve-3d;
            animation: breathe 4s ease-in-out infinite;

            /* PREVENIR SCROLL AL INTERACTUAR CON LA CARTA */
            touch-action: none;
            /* Previene el comportamiento de scroll predeterminado en touch devices */
            overscroll-behavior: contain;
            /* Evita que el scroll se propague al contenedor padre */
            -webkit-user-select: none;
            user-select: none;
        }

        /* Breathing stops on hover to not interfere with tilt */
        .card-stage:hover {
            animation-play-state: paused;
        }

        .card-stage.flipped {
            /* Flip state handled via variables */
            --flip-angle: 180deg;
        }

        /* CONTENEDOR INTERNO 3D - Maneja inclinaci√≥n y volteo */
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;

            /* Default: Fast transition for tilt responsiveness */
            transition: transform 0.1s ease-out;

            /* Combine Tilt (rx, ry) and Flip (flip-angle 0 or 180) */
            transform:
                rotateX(var(--rotate-x, 0deg)) rotateY(calc(var(--rotate-y, 0deg) + var(--flip-angle, 0deg)));
        }

        /* Slow transition only when flipping */
        .card-inner.is-flipping {
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: 26px;
            box-shadow: var(--shadow-card);
            overflow: hidden;
            /* Fix for Safari handling of overflow with 3D */
            transform: translateZ(0);
        }

        /* GLARE EFFECT (Iluminaci√≥n din√°mica) */
        .card-face::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at var(--glare-x, 50%) var(--glare-y, 50%),
                    rgba(255, 255, 255, 0.8) 0%,
                    rgba(255, 255, 255, 0) 60%);
            opacity: var(--glare-opacity, 0);
            mix-blend-mode: overlay;
            pointer-events: none;
            z-index: 10;
            transition: opacity 0.2s ease;
        }

        /* DORSO - Gradiente P√∫rpura/√çndigo solicitado */
        .front {
            /* Implementaci√≥n de: bg-gradient-to-br from-purple-900/20 to-indigo-900/20 */
            /* Y radial-gradient(circle at 30% 30%, rgba(147, 51, 234, 0.1) 0%, transparent 50%) */

            background-image:
                radial-gradient(circle at 30% 30%, rgba(147, 51, 234, 0.15) 0%, transparent 50%),
                linear-gradient(to bottom right, rgba(147, 51, 234, 0.25), rgba(79, 70, 229, 0.25));

            /* backdrop-blur-sm (aproximadamente 8px) */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);

            border: 1.5px solid rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow:
                var(--shadow-card),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        .keyword-highlight {
            position: relative;
            display: inline-block;
            padding: 2px 1px;
            font-weight: 800;

            /* TRANSPARENT TEXT - wallpaper colors show through */
            color: transparent;
            background: inherit;
            /* Inherit wallpaper background */
            -webkit-background-clip: text;
            background-clip: text;

            /* Subtle outline to define letter edges */
            -webkit-text-stroke: 0.3px rgba(255, 255, 255, 0.3);
            text-stroke: 0.3px rgba(255, 255, 255, 0.3);

            /* Allow blend with wallpaper */
            mix-blend-mode: normal;

            transition: all 0.3s ease;
        }

        /* Hover: Slightly stronger outline */
        .keyword-highlight:hover {
            -webkit-text-stroke: 0.5px rgba(255, 255, 255, 0.5);
            text-stroke: 0.5px rgba(255, 255, 255, 0.5);
            transform: scale(1.03);
        }

        /* NO pseudo-elementos (sin esferas ni brillos extras) */
        .keyword-highlight::before,
        .keyword-highlight::after {
            content: none !important;
            display: none !important;
        }

        /* S√≠mbolo lunar central - Ajustado para el nuevo fondo */
        .symbol {
            width: 70px;
            height: 70px;
            border: 1.5px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 300;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.05);
                opacity: 1;
            }
        }

        /* ANVERSO - La revelaci√≥n */
        .back {
            /* Fondo tipo cristal claro para la carta revelada */
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            transform: rotateY(180deg);
            border: 1px solid rgba(255, 255, 255, 0.5);
            overflow: hidden;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tarot-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center center;
            /* ELIMINACI√ìN DE FONDO BLANCO (Importante si las im√°genes lo tienen) */
            mix-blend-mode: darken;
            filter: contrast(1.1) saturate(1.1) brightness(1.05);
            transition: transform 4s var(--ease-smooth);
        }

        /* Efecto zoom al revelar */
        .card-stage.flipped .tarot-img {
            transform: scale(1.02);
        }

        /* ==================== VIDEO OVERLAY (LONG-PRESS) ==================== */
        .card-video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 26px;
            overflow: hidden;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
            z-index: 100;
            background: rgba(0, 0, 0, 0.05);
        }

        .card-video-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .card-video-overlay video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* Center alignment prevents uneven cropping */
            object-position: center center;
            background: transparent;
            /* Enhanced visibility and seamless integration */
            filter: brightness(1.05) contrast(1.03);
            border-radius: 26px;
            /* Match parent for perfect edge alignment */
            /* Prevent lag/jitter */
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
        }





        @media (max-width: 600px) {
            .card-collection-notification {
                width: 95%;
                padding: 12px 15px;
            }

            .card-slot {
                width: 45px;
                height: 72px;
            }

            .progress-text {
                font-size: 12px;
            }
        }






        /* ==================== PANEL DE LECTURA ==================== */
        /* Estilo Apple Music Lyrics */
        .insight-panel {
            width: 92%;
            max-width: 720px;
            background: rgba(245, 245, 245, 0.45);
            backdrop-filter: blur(var(--glass-blur)) saturate(150%);
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(150%);
            border-radius: 22px;
            padding: 32px 42px 36px;
            border: 1.5px solid var(--glass-border);
            box-shadow:
                var(--shadow-soft),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);

            /* Estado inicial: invisible */
            opacity: 0;
            transform: translateY(25px) scale(0.96);
            transition: all 0.9s var(--ease-smooth);
            text-align: left;
            pointer-events: none;
            z-index: 5;
            margin-bottom: 60px;
            flex-shrink: 0;
        }

        .insight-panel.active {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        /* T√çTULO Y TEXTOS - AJUSTADOS PARA LECTURA SOBRE CRISTAL CLARO */

        h2 {
            margin: 0 0 22px 0;
            font-weight: 700;
            font-size: 1.5rem;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            text-align: center;
            color: var(--text-primary);
            /* Efecto de texto "grabado" sutil en lugar de shimmer brillante */
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.7);
            animation: fadeSlideIn 0.6s var(--ease-smooth) 0.2s both;
        }

        /* SECCIONES DE CONTENIDO */
        .section {
            margin-bottom: 24px;
            animation: fadeSlideIn 0.7s var(--ease-smooth) both;
        }

        .section:nth-child(2) {
            animation-delay: 0.3s;
        }

        .section:nth-child(3) {
            animation-delay: 0.4s;
        }

        .section:nth-child(4) {
            animation-delay: 0.5s;
        }

        .section:nth-child(5) {
            animation-delay: 0.6s;
        }

        .section:nth-child(6) {
            animation-delay: 0.7s;
        }

        .section:nth-child(7) {
            animation-delay: 0.8s;
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin: 0 0 8px 0;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.7);
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
        }

        .section-title:hover {
            color: var(--accent-primary);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.9);
        }

        .section-title::after {
            content: '>';
            opacity: 0.6;
            font-weight: 300;
            font-size: 0.75em;
            transition: opacity 0.2s ease;
        }

        .section-title:hover::after {
            opacity: 0.9;
            color: var(--accent-primary);
        }

        .intro-section {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 16px 20px;
            margin: 0 0 24px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            animation: fadeSlideIn 0.6s ease-out;
        }

        .intro-text {
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-primary);
            margin: 0;
            text-align: justify;
        }

        .intro-text em {
            color: var(--accent-primary);
            font-weight: 500;
            font-style: italic;
        }

        .section-content {
            font-size: 1rem;
            line-height: 1.7;
            color: var(--text-primary);
            font-weight: 400;
            margin: 0;
        }

        .biblical-verse {
            font-style: italic;
            border-left: 2px solid rgba(0, 0, 0, 0.2);
            padding-left: 16px;
            margin-top: 6px;
            color: var(--text-secondary);
        }

        .verse-reference {
            display: block;
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--text-tertiary);
            font-style: normal;
            text-align: right;
        }

        /* ==================== FLOATING STARS (APPLE-STYLE MAGNETIC SCROLL) ==================== */
        .floating-star {
            position: fixed;
            width: 3px;
            /* Smaller dots like Apple */
            height: 3px;
            background: rgba(255, 255, 255, 0.9);
            /* White dots */
            border-radius: 50%;
            /* Perfect circles */
            pointer-events: none;
            z-index: 1;
            transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            will-change: transform;
            filter: drop-shadow(0 0 1px rgba(255, 255, 255, 0.5));
            /* Subtle white glow */
            animation: starTwinkle 2s ease-in-out infinite;
            animation-delay: var(--delay, 0s);
        }

        @keyframes starTwinkle {

            0%,
            100% {
                opacity: 0.3;
            }

            50% {
                opacity: 0.8;
            }
        }

        /* ==================== MODAL GLASSMORPHISM BLANCO ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: modalFadeIn 0.3s ease-out;
            padding: 20px;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            box-shadow:
                0 25px 50px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            max-width: 700px;
            width: 100%;
            /* FIX SCROLL: Limitar altura y usar flex column */
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            animation: modalSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .modal-header {
            padding: 24px 28px 20px 28px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* Header no se encoge */
            flex-shrink: 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c2c2c;
        }

        .ai-btn {
            /* El bot√≥n es el MICROCOSMOS: Refleja los colores del MACROCOSMOS (Fondo) */
            background: linear-gradient(135deg, var(--color1, #ffffff), var(--color2, #e0e0e0));
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #2c2c2c;
        }

        .modal-body {
            padding: 24px 28px;
            /* SCROLLABLE */
            overflow-y: auto;
            flex-grow: 1;
        }

        .modal-body p {
            margin: 0;
            font-size: 1.1rem;
            line-height: 1.7;
            color: #333;
            text-align: justify;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .modal-footer {
            padding: 16px 28px 28px 28px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            text-align: right;
        }

        .modal-footer small {
            font-size: 0.9rem;
            color: #666;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Apple Music-style letter reveal with white fill */
        @keyframes letterReveal {
            0% {
                opacity: 0;
                transform: translateY(8px) scale(0.9);
                filter: blur(3px);
            }

            50% {
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }

        /* White fill animation */
        @keyframes whiteFill {
            from {
                color: rgba(0, 0, 0, 0.3);
            }

            to {
                color: rgba(255, 255, 255, 0.9);
                text-shadow:
                    0 0 8px rgba(255, 255, 255, 0.6),
                    0 0 12px rgba(255, 255, 255, 0.3);
            }
        }

        /* Class for animating letters individually */
        .letter-animate {
            display: inline-block;
            opacity: 0;
            animation: letterReveal 0.6s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
            animation-play-state: paused;
        }

        .letter-animate.reveal {
            animation-play-state: running;
        }

        /* Apply white fill after reveal */
        .letter-animate.reveal.fill {
            animation:
                letterReveal 0.6s cubic-bezier(0.4, 0.0, 0.2, 1) forwards,
                whiteFill 0.8s cubic-bezier(0.4, 0.0, 0.2, 1) 0.4s forwards;
        }

        /* TEXTO DE LECTURA */
        p {
            margin: 0;
            font-size: 1rem;
            line-height: 1.7;
            color: var(--text-primary);
            font-weight: 400;
        }

        /* BOT√ìN DE REINICIO - ELIMINADO (Se eliminan los estilos .card-reset-btn) */



        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 1024px) {
            .card-stage {
                width: 260px;
                height: 460px;
            }

            .insight-panel {
                width: 90%;
                max-width: 600px;
            }

            .blob {
                filter: blur(90px);
            }
        }

        @media (max-width: 768px) {
            .card-stage {
                width: 236px;
                height: 420px;
            }

            .insight-panel {
                width: 94%;
                max-width: 500px;
                padding: 22px 28px;
            }

            h2 {
                font-size: 1.1rem;
            }

            p,
            .section-content {
                font-size: 0.92rem;
                line-height: 1.65;
            }

            .blob {
                filter: blur(70px);
            }
        }

        @media (max-width: 480px) {
            .card-stage {
                width: 220px;
                height: 390px;
            }

            .insight-panel {
                width: 96%;
                padding: 18px 24px;
                max-width: 400px;
            }

            h2 {
                font-size: 1rem;
                letter-spacing: 1px;
                margin-bottom: 12px;
            }

            p,
            .section-content {
                font-size: 0.88rem;
            }
        }

        @media (max-width: 360px) {
            .card-stage {
                width: 180px;
                height: 320px;
            }

            .insight-panel {
                width: 98%;
                padding: 16px 20px;
            }

            h2 {
                font-size: 0.95rem;
            }

            p,
            .section-content {
                font-size: 0.85rem;
            }
        }

        /* ==================== ACCESIBILIDAD ==================== */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            .blob {
                animation: none !important;
            }
        }

        /* ==================== APPLE MUSIC READING EFFECT ==================== */

        .reading-unit {
            opacity: 0.35;
            filter: blur(1.5px);
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: inline-block;
            /* Or block depending on flow */
        }

        .reading-unit.active {
            opacity: 1;
            filter: blur(0);
        }

        /* ==================== KEYWORD HIGHLIGHTING - FIXED TRANSPARENCY ==================== */

        /* Keywords: "Crystal" effect allowing background blobs to show through */
        .keyword-highlight {
            /* TRANSPARENT TEXT - wallpaper shows through */
            color: transparent;
            background: inherit;
            -webkit-background-clip: text;
            background-clip: text;

            font-weight: 700;
            position: relative;
            display: inline-block;

            /* Subtle outline */
            -webkit-text-stroke: 0.3px rgba(255, 255, 255, 0.3);

            mix-blend-mode: normal;
            transition: all 0.5s ease;
        }

        /* Filled/Active state - same transparent */
        .keyword-highlight.filled {
            -webkit-text-stroke: 0.4px rgba(255, 255, 255, 0.4);
        }

        .keyword-highlight:hover {
            transform: scale(1.05);
            -webkit-text-stroke: 0.5px rgba(255, 255, 255, 0.5);
        }



        /* ==================== ESTILOS BOT√ìN IA ==================== */
        .ai-synthesis-container {
            margin-top: 40px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .ai-btn {
            /* El bot√≥n es el MICROCOSMOS: Refleja los colores del MACROCOSMOS (Fondo) */
            /* Fondo base transl√∫cido para las mini-blobs */
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        /* Mini-blob 1 - Movimiento lento */
        .ai-btn::before {
            content: '';
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--color1, #ffd1dc);
            filter: blur(25px);
            mix-blend-mode: multiply;
            opacity: 0.6;
            top: -20px;
            left: -10px;
            animation: microMove1 12s ease-in-out infinite alternate;
            z-index: 1;
        }

        /* Mini-blob 2 - Movimiento diferente */
        .ai-btn::after {
            content: '';
            position: absolute;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--color2, #b8e0ff);
            filter: blur(20px);
            mix-blend-mode: multiply;
            opacity: 0.5;
            bottom: -15px;
            right: -10px;
            animation: microMove2 14s ease-in-out infinite alternate;
            z-index: 1;
        }

        .ai-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }

        .ai-btn:active {
            transform: scale(0.95);
        }

        .ai-btn:disabled {
            opacity: 0.7;
            cursor: wait;
            filter: grayscale(0.5);
        }

        /* Icono dentro del bot√≥n (opcional, o solo el color) */
        .ai-btn-icon {
            position: relative;
            z-index: 2;
            font-size: 1.5rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            transition: transform 0.5s ease;
        }

        /* Estado "Pensando" (Microcosmo activo) */
        .ai-btn.thinking {
            animation: liquidButton 2s ease infinite, pulseMicro 1.5s ease-in-out infinite;
            cursor: wait;
        }

        .ai-btn.thinking .ai-btn-icon {
            animation: spinStar 2s linear infinite;
        }

        @keyframes pulseMicro {
            0% {
                transform: scale(1);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            }

            50% {
                transform: scale(1.1);
                box-shadow: 0 0 30px rgba(255, 255, 255, 0.6);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            }
        }

        @keyframes spinStar {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Animaciones micro para las mini-blobs del bot√≥n */
        @keyframes microMove1 {
            from {
                transform: translate(-5px, -5px) scale(1);
            }

            to {
                transform: translate(10px, 8px) scale(1.2);
            }
        }

        @keyframes microMove2 {
            from {
                transform: translate(8px, -6px) scale(0.9);
            }

            to {
                transform: translate(-7px, 10px) scale(1.1);
            }
        }

        .ai-result {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.5);
            animation: fadeSlideIn 0.5s ease-out;
        }

        .ai-header {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-primary);
            /* Negro/Oscuro */
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding-bottom: 8px;
        }

        .ai-result p {
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text-primary);
            font-style: italic;
        }

        /* BOT√ìN DE IDIOMA (TOP-RIGHT, MINIMALIST) */
        .lang-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: transparent;
            border: none;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.8rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .lang-btn:hover {
            transform: scale(1.15);
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .lang-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* TIP DE INTERACCI√ìN ELIMINADO */
    </style>
</head>

<body>

    <!-- 3-Card Collection Notification -->
    <div class="card-collection-notification" id="cardCollectionNotif">
        <div class="collection-content">
            <div class="collection-header">
                <div class="progress-dots">
                    <div class="dot" id="dot1"></div>
                    <div class="progress-line" id="line1"></div>
                    <div class="dot" id="dot2"></div>
                    <div class="progress-line" id="line2"></div>
                    <div class="dot" id="dot3"></div>
                </div>
                <!-- Progress counter removed per user request -->
            </div>

            <div class="card-slots">
                <div class="card-slot empty" id="slot1">
                    <span class="slot-placeholder"></span>
                </div>
                <div class="card-slot empty" id="slot2">
                    <span class="slot-placeholder"></span>
                </div>
                <div class="card-slot empty" id="slot3">
                    <span class="slot-placeholder"></span>
                </div>
            </div>

            <div class="composite-message" id="compositeMessage" style="display:none;">
                <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:8px;">
                    <span class="composite-icon">‚ú®</span>
                    <span class="composite-text">Lectura Compuesta Completa</span>
                </div>
                <button class="composite-email-btn" id="compositeEmailBtn">
                    üìß Solicitar Lectura Profunda
                </button>
            </div>
        </div>
    </div>


    <div class="wallpaper" id="wallpaper">
        <div class="blob blob1"></div>
        <div class="blob blob2"></div>
        <div class="blob blob3"></div>
        <div class="blob blob4"></div>
    </div>
    <div class="noise-overlay"></div>

    <!-- Bot√≥n de Idioma -->
    <button class="lang-btn iridescent-border-subtle" id="langBtn" onclick="toggleLanguage()"
        aria-label="Change Language">
        üåê
    </button>

    <!-- Collection Button (Top-Left, Transparent) -->
    <button class="collection-btn" id="collectionBtn" aria-label="Ver Colecci√≥n">
        üÉè
    </button>
    <style>
        .collection-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: transparent;
            border: none;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 2rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .collection-btn:hover {
            transform: scale(1.15);
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        }
    </style>

    <div class="interface">
        <div class="card-stage" id="cardStage">
            <div class="card-inner">
                <div class="card-face front iridescent-border">
                    <div class="symbol">‚òæ</div>
                </div>
                <div class="card-face back iridescent-border">
                    <img id="cardImg" src="" alt="Arcano del Tarot" class="tarot-img">
                </div>

                <!-- Video Overlay (activated on long-press) -->
                <div class="card-video-overlay" id="videoOverlay">
                    <video id="cardVideo" muted playsinline preload="auto">
                        <source id="videoSource" src="" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>
        </div>

        <!-- Tap Hint Removed -->

        <div class="insight-panel iridescent-border" id="insightPanel">
            <h2 id="cardTitle"></h2>

            <div class="intro-section" id="introSection" style="display:none;">
                <p class="intro-text"><em id="introExample"></em></p>
            </div>

            <div class="section" id="seccionSignificado">
                <div class="section-title" id="titleArquetipo"></div>
                <p class="section-content" id="textoSignificado"></p>
            </div>

            <div class="section" id="seccionAmpliado" style="display:none;">
                <div class="section-title" id="titleMisticismo"></div>
                <p class="section-content" id="textoAmpliado"></p>
            </div>

            <div class="section" id="seccionNegativo" style="display:none;">
                <div class="section-title" id="titleSombra"></div>
                <p class="section-content" id="textoNegativo"></p>
            </div>

            <div class="section" id="seccionBotanica" style="display:none;">
                <div class="section-title" id="titleBotanica"></div>
                <p class="section-content" id="textoBotanica"></p>
            </div>

            <div class="section" id="seccionCotidiano" style="display:none;">
                <div class="section-title" id="titleCotidiano"></div>
                <p class="section-content" id="textoCotidiano"></p>
            </div>

            <div class="section" id="seccionMistico" style="display:none;">
                <div class="section-title" id="titleGnosis"></div>
                <p class="section-content" id="textoMistico"></p>
            </div>

            <div class="section" id="seccionBiblico" style="display:none;">
                <div class="section-title" id="titleResonanciaBiblica"></div>
                <div class="section-content">
                    <div class="biblical-verse" id="textoBiblico"></div>
                </div>
            </div>

            <!-- Bot√≥n de S√≠ntesis IA -->
            <div class="ai-synthesis-container">
                <button class="ai-btn iridescent-border-subtle" id="aiBtn" aria-label="Sintetizar Numerolog√≠a">
                    <span class="ai-btn-icon">‚ú¶</span>
                </button>
                <div class="ai-result" id="aiResult" style="display:none;">
                    <div class="ai-header">
                        <span class="ai-icon-small">‚ú¶</span> Numerolog√≠a
                    </div>
                    <p id="aiText"></p>
                </div>
            </div>
        </div>

        <!-- Modal para ejemplos de los 22 conceptos -->
        <div class="modal-overlay" id="modalOverlay" style="display: none;">
            <div class="modal-content iridescent-border" id="modalContent">
                <div class="modal-header">
                    <h3 id="modalTitle"></h3>
                    <button class="modal-close" id="modalClose">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="modalText"></p>
                </div>
                <div class="modal-footer">
                    <small id="modalNumber"></small>
                </div>
            </div>
        </div>

        <!-- Portal de An√°lisis Personal - Modal Expandido -->
        <div class="modal-overlay" id="collectionModal" style="display: none;">
            <div class="modal-content iridescent-border" style="max-width: 800px;">
                <div class="modal-header">
                    <h3>‚ú® Portal de An√°lisis Personal</h3>
                    <button class="modal-close" id="collectionClose">&times;</button>
                </div>

                <!-- Main Tab Navigation -->
                <div class="portal-tabs">
                    <button class="portal-tab active" data-tab="collection">
                        üìö Colecci√≥n
                    </button>
                    <button class="portal-tab" data-tab="deep-analysis">
                        üîÆ An√°lisis Profundo <span style="font-size:0.8em; opacity:0.7;">(10 WLD)</span>
                    </button>
                </div>

                <!-- TAB 1: Collection History -->
                <div class="portal-tab-content active" id="tab-collection">
                    <div class="modal-body" id="collectionList"
                        style="max-height: 500px; overflow-y: auto; padding: 20px;">
                        <!-- Cards will be injected here -->
                        <p style="text-align:center; opacity:0.7; padding: 20px;">A√∫n no has descubierto cartas en esta
                            sesi√≥n.</p>
                    </div>
                </div>

                <!-- TAB 2: Deep Analysis -->
                <div class="portal-tab-content" id="tab-deep-analysis">
                    <div class="modal-body" style="padding: 30px;">

                        <!-- Personal Data Form (Always visible at top) -->
                        <div class="personal-data-form" id="personalDataForm">
                            <h4 style="margin-bottom: 20px;">üìã Datos Personales</h4>

                            <div class="form-group">
                                <label class="form-label">Nombre Completo:</label>
                                <input type="text" id="fullName" class="form-input" placeholder="Tu nombre completo">
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label class="form-label">Fecha de Nacimiento:</label>
                                    <input type="date" id="birthDate" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Hora de Nacimiento:</label>
                                    <input type="time" id="birthTime" class="form-input">
                                </div>
                            </div>

                            <!-- Unified Location Input with Google Maps -->
                            <div class="form-group">
                                <label class="form-label">üìç Ubicaci√≥n de Nacimiento:</label>
                                <input type="text" id="locationSearch" class="form-input"
                                    placeholder="Buscar direcci√≥n o lugar (ej: Hospital Italiano, Buenos Aires)">
                                <p style="font-size: 0.85rem; opacity: 0.7; margin-top: 5px;">Escribe para buscar o
                                    selecciona manualmente en el mapa</p>
                            </div>

                            <!-- Google Maps -->
                            <div id="googleMap"
                                style="height: 250px; border-radius: 12px; background: rgba(255,255,255,0.05); margin: 15px 0; border: 1px solid rgba(255,255,255,0.1);">
                            </div>

                            <!-- Coordinates Display -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                                <div
                                    style="padding: 10px; background: rgba(255,255,255,0.08); border-radius: 8px; font-size: 0.9rem;">
                                    <strong>Lat:</strong> <span id="selectedLat">-</span>
                                </div>
                                <div
                                    style="padding: 10px; background: rgba(255,255,255,0.08); border-radius: 8px; font-size: 0.9rem;">
                                    <strong>Lng:</strong> <span id="selectedLng">-</span>
                                </div>
                            </div>
                            <input type="hidden" id="selectedAddress" value="">
                        </div>

                        <div style="border-top: 2px solid rgba(255,255,255,0.2); margin: 30px 0;"></div>

                        <!-- Sub-Tabs for Analysis Types -->
                        <div class="analysis-sub-tabs" style="display: flex; gap: 10px; margin-bottom: 25px;">
                            <button class="analysis-sub-tab active" data-subtab="mind">üß† Mente</button>
                            <button class="analysis-sub-tab" data-subtab="body">‚öñÔ∏è Cuerpo</button>
                            <button class="analysis-sub-tab" data-subtab="natal">‚≠ê Natal</button>
                        </div>

                        <!-- Sub-Tab Content: Mind Analysis -->
                        <div class="analysis-sub-content active" id="subtab-mind">
                            <h4>üß† An√°lisis de Mente (10 Cartas)</h4>
                            <p class="section-description" style="opacity: 0.8; margin-bottom: 20px;">
                                Eval√∫a tu estado cerebral, desarrollo neuronal y activaci√≥n pineal mediante una tirada
                                de 10 cartas del deck completo (78 cartas).
                            </p>
                            <button class="analysis-btn" id="requestMindAnalysis" style="width: 100%;">
                                <span class="btn-icon">üß¨</span>
                                Realizar Tirada de Mente
                            </button>
                            <div id="mindAnalysisResult" class="analysis-result"
                                style="display:none; margin-top: 20px;"></div>
                        </div>

                        <!-- Sub-Tab Content: Body Analysis -->
                        <div class="analysis-sub-content" id="subtab-body" style="display:none;">
                            <h4>‚öñÔ∏è An√°lisis de Cuerpo (10 Cartas)</h4>
                            <p class="section-description" style="opacity: 0.8; margin-bottom: 20px;">
                                Analiza el equilibrio hemisf√©rico (l√≥gica vs intuici√≥n) y armonizaci√≥n corporal con 10
                                cartas.
                            </p>
                            <button class="analysis-btn" id="requestBodyAnalysis" style="width: 100%;">
                                <span class="btn-icon">üåì</span>
                                Realizar Tirada de Cuerpo
                            </button>
                            <div id="bodyAnalysisResult" class="analysis-result"
                                style="display:none; margin-top: 20px;"></div>
                        </div>

                        <!-- Sub-Tab Content: Natal Chart -->
                        <div class="analysis-sub-content" id="subtab-natal" style="display:none;">
                            <h4>‚≠ê Carta Natal Completa</h4>
                            <p class="section-description" style="opacity: 0.8; margin-bottom: 20px;">
                                S√≠ntesis hol√≠stica que integra tu carta natal astrol√≥gica con los an√°lisis de Mente y
                                Cuerpo.
                            </p>
                            <button class="analysis-btn" id="calculateNatalChart" style="width: 100%;">
                                <span class="btn-icon">‚ú®</span>
                                Generar An√°lisis Completo
                            </button>
                            <div id="natalChartResult" class="analysis-result" style="display:none; margin-top: 20px;">
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Estilos para el Portal Expandido -->
        <style>
            /* Tab Navigation */
            .portal-tabs {
                display: flex;
                gap: 8px;
                padding: 15px 20px 0 20px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            }

            .portal-tab {
                flex: 1;
                padding: 12px 16px;
                background: rgba(255, 255, 255, 0.1);
                border: none;
                border-radius: 8px 8px 0 0;
                cursor: pointer;
                font-size: 0.9rem;
                font-weight: 600;
                color: rgba(255, 255, 255, 0.7);
                transition: all 0.3s ease;
                position: relative;
            }

            .portal-tab:hover {
                background: rgba(255, 255, 255, 0.15);
                color: rgba(255, 255, 255, 0.9);
            }

            .portal-tab.active {
                background: rgba(255, 255, 255, 0.25);
                color: #fff;
                border-bottom: 2px solid rgba(255, 255, 255, 0.8);
            }

            /* Tab Content */
            .portal-tab-content {
                display: none;
            }

            .portal-tab-content.active {
                display: block;
            }

            /* Analysis Sub-Tabs (for Mind/Body/Natal) */
            .analysis-sub-tabs {
                display: flex;
                gap: 10px;
                margin-bottom: 25px;
            }

            .analysis-sub-tab {
                flex: 1;
                padding: 10px 14px;
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 8px;
                cursor: pointer;
                font-size: 0.85rem;
                font-weight: 500;
                color: rgba(255, 255, 255, 0.7);
                transition: all 0.3s ease;
            }

            .analysis-sub-tab:hover {
                background: rgba(255, 255, 255, 0.12);
                color: rgba(255, 255, 255, 0.9);
                border-color: rgba(255, 255, 255, 0.3);
            }

            .analysis-sub-tab.active {
                background: rgba(255, 255, 255, 0.2);
                color: #fff;
                border-color: rgba(255, 255, 255, 0.5);
                font-weight: 600;
            }

            /* Sub-Tab Content */
            .analysis-sub-content {
                display: none;
            }

            .analysis-sub-content.active {
                display: block;
            }

            /* Analysis Sections */
            .analysis-section {
                background: rgba(255, 255, 255, 0.08);
                border-radius: 12px;
                padding: 20px;
                border: 1px solid rgba(255, 255, 255, 0.15);
            }

            .analysis-section h4 {
                margin: 0 0 10px 0;
                font-size: 1.1rem;
                font-weight: 700;
            }

            .section-description {
                margin: 0 0 15px 0;
                opacity: 0.8;
                font-size: 0.9rem;
                line-height: 1.5;
            }

            .analysis-btn {
                width: 100%;
                padding: 14px 20px;
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.3);
                border-radius: 10px;
                cursor: pointer;
                font-size: 1rem;
                font-weight: 600;
                color: #fff;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                transition: all 0.3s ease;
            }

            .analysis-btn:hover {
                background: rgba(255, 255, 255, 0.3);
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            }

            .analysis-btn .btn-icon {
                font-size: 1.3rem;
            }

            .analysis-result {
                margin-top: 20px;
                padding: 20px;
                background: rgba(255, 255, 255, 0.15);
                border-radius: 10px;
                border: 1px solid rgba(255, 255, 255, 0.25);
                line-height: 1.7;
            }

            /* Form Styles */
            .form-group {
                margin-bottom: 20px;
            }

            .form-label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                font-size: 0.9rem;
                opacity: 0.9;
            }

            .form-input {
                width: 100%;
                padding: 12px 16px;
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.3);
                border-radius: 8px;
                color: #fff;
                font-size: 1rem;
                transition: all 0.3s ease;
            }

            .form-input:focus {
                outline: none;
                background: rgba(255, 255, 255, 0.15);
                border-color: rgba(255, 255, 255, 0.5);
            }

            .form-input::placeholder {
                color: rgba(255, 255, 255, 0.5);
            }

            .radio-group {
                display: flex;
                gap: 15px;
            }

            .radio-label {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 10px 16px;
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .radio-label:has(input:checked) {
                background: rgba(255, 255, 255, 0.25);
                border-color: rgba(255, 255, 255, 0.5);
            }

            .radio-label input {
                margin: 0;
            }

            .location-input {
                margin-top: 20px;
            }

            .map-placeholder {
                text-align: center;
                padding: 20px;
            }

            .map-notice {
                font-size: 0.85rem;
                opacity: 0.7;
                margin-top: 5px;
            }

            .coordinates-display {
                margin-top: 15px;
                padding: 15px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                font-size: 0.9rem;
            }

            .coordinates-display p {
                margin: 5px 0;
            }
        </style>

    </div>

    <script>
        /* ==================== CONFIGURACI√ìN WORLD APP ==================== */
        const WALLET_ADDRESS = '0xa3cdea9fe705bc16dcd9e9170e217b0f1ba5aaf6';

        // Detectar modo "Amigos" (Gratis) v√≠a URL: ?mode=friends
        const urlParams = new URLSearchParams(window.location.search);
        const IS_FRIENDS_MODE = urlParams.get('mode') === 'friends';

        // Inicializar MiniKit
        try {
            if (window.MiniKit) {
                window.MiniKit.install();
            }
        } catch (e) {
            console.log('MiniKit not initialized (running outside World App?)');
        }

        /* =====================================================
           L√ìGICA DEL OR√ÅCULO
        ===================================================== */

        const cardStage = document.getElementById('cardStage');
        const cardInner = document.querySelector('.card-inner'); // Reference to inner for class toggling
        const insightPanel = document.getElementById('insightPanel');
        const cardTitle = document.getElementById('cardTitle');
        const cardImg = document.getElementById('cardImg');

        const wallpaper = document.getElementById('wallpaper');

        // Elementos de las 6 secciones
        const textoSignificado = document.getElementById('textoSignificado');
        const textoAmpliado = document.getElementById('textoAmpliado');
        const textoNegativo = document.getElementById('textoNegativo');
        const textoBotanica = document.getElementById('textoBotanica');
        const textoCotidiano = document.getElementById('textoCotidiano');
        const textoMistico = document.getElementById('textoMistico');
        const textoBiblico = document.getElementById('textoBiblico');

        const seccionAmpliado = document.getElementById('seccionAmpliado');
        const seccionNegativo = document.getElementById('seccionNegativo');
        const seccionBotanica = document.getElementById('seccionBotanica');
        const seccionCotidiano = document.getElementById('seccionCotidiano');
        const seccionMistico = document.getElementById('seccionMistico');
        const seccionBiblico = document.getElementById('seccionBiblico');

        let isRevealed = false;
        let isProcessing = false;
        let currentCardData = null;

        /* ==================== COLLECTION SYSTEM (NO LIMIT) ==================== */
        let collectedCards = JSON.parse(sessionStorage.getItem('collectedCards') || '[]');

        // Function to add card to collection with timestamp
        function addCardToCollection(cardData) {
            // Check if card already collected
            if (collectedCards.find(c => c.name_short === cardData.name_short)) {
                return; // Already have this card
            }

            // Add card with timestamp
            collectedCards.push({
                name_short: cardData.name_short,
                image: `./public/cards/${cardData.name_short}.jpg`,
                name: cardData.name,
                timestamp: new Date().toISOString(),
                order: collectedCards.length + 1
            });

            // Save to session
            sessionStorage.setItem('collectedCards', JSON.stringify(collectedCards));
        }




        // Arrays globales para almacenar todos los conceptos por categor√≠a (22 conceptos cada uno)
        let allArquetipos = [];
        let allMisticismos = [];
        let allSombras = [];
        let allBotanicas = [];
        let allCotidianos = [];
        let allGnosis = [];
        let allResonanciasBiblicas = [];

        // √çndices de ejemplo pre-calculados para esta sesi√≥n (para consistencia)
        let currentExampleIndices = {
            arquetipo: 0,
            misticismo: 0,
            sombra: 0,
            botanica: 0,
            cotidiano: 0,
            gnosis: 0,
            resonancia_biblica: 0
        };

        // Variable para controlar el timeout del reset de color
        let resetColorTimeout = null;

        /* =====================================================
           FULL 78-CARD TAROT DECK WITH REVERSALS
        ===================================================== */

        // Major Arcana (22 cards)
        const MAJOR_ARCANA = [
            'ar00', 'ar01', 'ar02', 'ar03', 'ar04', 'ar05', 'ar06', 'ar07',
            'ar08', 'ar09', 'ar10', 'ar11', 'ar12', 'ar13', 'ar14', 'ar15',
            'ar16', 'ar17', 'ar18', 'ar19', 'ar20', 'ar21'
        ];

        // Minor Arcana - Wands (Bastos/Fuego) - 14 cards
        const WANDS = [
            'wands_ace', 'wands_02', 'wands_03', 'wands_04', 'wands_05', 'wands_06', 'wands_07',
            'wands_08', 'wands_09', 'wands_10', 'wands_page', 'wands_knight', 'wands_queen', 'wands_king'
        ];

        // Minor Arcana - Cups (Copas/Agua) - 14 cards  
        const CUPS = [
            'cups_ace', 'cups_02', 'cups_03', 'cups_04', 'cups_05', 'cups_06', 'cups_07',
            'cups_08', 'cups_09', 'cups_10', 'cups_page', 'cups_knight', 'cups_queen', 'cups_king'
        ];

        // Minor Arcana - Swords (Espadas/Aire) - 14 cards
        const SWORDS = [
            'swords_ace', 'swords_02', 'swords_03', 'swords_04', 'swords_05', 'swords_06', 'swords_07',
            'swords_08', 'swords_09', 'swords_10', 'swords_page', 'swords_knight', 'swords_queen', 'swords_king'
        ];

        // Minor Arcana - Pentacles (Oros/Tierra) - 14 cards
        const PENTACLES = [
            'pentacles_ace', 'pentacles_02', 'pentacles_03', 'pentacles_04', 'pentacles_05', 'pentacles_06', 'pentacles_07',
            'pentacles_08', 'pentacles_09', 'pentacles_10', 'pentacles_page', 'pentacles_knight', 'pentacles_queen', 'pentacles_king'
        ];

        // FULL 78-CARD DECK
        const FULL_DECK = [
            ...MAJOR_ARCANA,  // 22
            ...WANDS,          // 14
            ...CUPS,           // 14
            ...SWORDS,         // 14
            ...PENTACLES       // 14
        ]; // Total: 78 cards

        /**
         * Draw N cards from full deck with reversals (for deep analysis)
         * @param {number} count - Number of cards to draw (default 10)
         * @returns {Array} Array of card objects with {card, reversed, position, positionName}
         */
        function drawCardSpread(count = 10) {
            const drawn = [];
            const available = [...FULL_DECK]; // Copy deck

            for (let i = 0; i < count && available.length > 0; i++) {
                const index = Math.floor(Math.random() * available.length);
                const cardId = available.splice(index, 1)[0]; // Remove from deck (no duplicates)
                const reversed = Math.random() < 0.5; // 50% chance of reversal

                drawn.push({
                    card: cardId,
                    reversed: reversed,
                    position: i + 1,
                    positionName: getPositionName(i + 1),
                    element: getCardElement(cardId)
                });
            }

            return drawn;
        }

        /**
         * Get position meaning in 10-card Celtic Cross spread
         */
        function getPositionName(position) {
            const positions = {
                1: 'Situaci√≥n Actual',
                2: 'Desaf√≠o Inmediato',
                3: 'Causa Ra√≠z',
                4: 'Pasado Reciente',
                5: 'Mejor Resultado Posible',
                6: 'Futuro Inmediato',
                7: 'Tu Actitud',
                8: 'Influencias Externas',
                9: 'Esperanzas y Miedos',
                10: 'Resultado Final'
            };
            return positions[position] || `Posici√≥n ${position}`;
        }

        /**
         * Get suit element (for esoteric analysis)
         */
        function getCardElement(cardId) {
            if (cardId.startsWith('wands_')) return 'Fuego';
            if (cardId.startsWith('cups_')) return 'Agua';
            if (cardId.startsWith('swords_')) return 'Aire';
            if (cardId.startsWith('pentacles_')) return 'Tierra';
            return 'Esp√≠ritu'; // Major Arcana
        }

        /* ==================== PALETAS DE COLORES RIDER-WAITE ==================== */
        // Basado en los colores visualmente dominantes y simb√≥licos de las cartas est√°ndar.
        const colorPalettes = {
            'ar00': ['#FFEB3B', '#81D4FA', '#FFFFFF', '#F44336'], // El Loco: Amarillo brillante, Azul claro, Blanco, Rojo
            'ar01': ['#F44336', '#FFFFFF', '#FFC107', '#4CAF50'], // El Mago: Rojo, Blanco, Amarillo, Verde
            'ar02': ['#64B5F6', '#FFFFFF', '#B0BEC5', '#1976D2'], // La Sacerdotisa: Azul claro, Blanco, Gris claro, Azul oscuro
            'ar03': ['#FFC107', '#4CAF50', '#F44336', '#FFF9C4'], // La Emperatriz: Amarillo, Verde, Rojo, Crema
            'ar04': ['#D32F2F', '#FF9800', '#9E9E9E', '#B0BEC5'], // El Emperador: Rojo oscuro, Naranja, Gris claro
            'ar05': ['#F44336', '#757575', '#FFFFFF', '#FFC107'], // El Sumo Sacerdote: Rojo, Gris, Blanco, Oro
            'ar06': ['#81D4FA', '#FFEB3B', '#4CAF50', '#9C27B0'], // Los Enamorados: Azul claro, Amarillo sol, Verde, P√∫rpura
            'ar07': ['#B0BEC5', '#2196F3', '#FFC107', '#616161'], // El Carro: Gris, Azul, Oro, Negro/Gris
            'ar08': ['#FFFFFF', '#FF9800', '#8BC34A', '#F44336'], // La Fuerza: Blanco, Naranja, Verde claro, Rojo le√≥n
            'ar09': ['#9E9E9E', '#616161', '#B0BEC5', '#FFEB3B'], // El Ermita√±o: Grises, Amarillo estrella
            'ar10': ['#FF9800', '#2196F3', '#F44336', '#FFC107'], // La Rueda: Naranja, Azul, Rojo, Oro
            'ar11': ['#D32F2F', '#4CAF50', '#FFC107', '#9E9E9E'], // La Justicia: Rojo oscuro, Verde, Oro, Gris
            'ar12': ['#2196F3', '#F44336', '#9E9E9E', '#FFEB3B'], // El Colgado: Azul, Rojo, Gris, Amarillo halo
            'ar13': ['#616161', '#FFFFFF', '#9E9E9E', '#FFEB3B'], // La Muerte: Gris oscuro, Blanco, Gris, Amarillo sol
            'ar14': ['#FFFFFF', '#81D4FA', '#FFC107', '#F44336'], // La Templanza: Blanco, Azul claro, Oro, Rojo
            'ar15': ['#424242', '#757575', '#F44336', '#795548'], // El Diablo: Negro, Gris, Rojo, Marr√≥n
            'ar16': ['#9E9E9E', '#616161', '#F44336', '#FFEB3B'], // La Torre: Gris, Negro, Rojo fuego, Amarillo rayo
            'ar17': ['#64B5F6', '#FFC107', '#4CAF50', '#FFFFFF'], // La Estrella: Azul claro, Amarillo, Verde, Blanco
            'ar18': ['#FFC107', '#2196F3', '#9E9E9E', '#1976D2'], // La Luna: Amarillo, Azul, Gris, Azul oscuro
            'ar19': ['#FFEB3B', '#FF9800', '#FFFFFF', '#F44336'], // El Sol: Amarillo brillante, Naranja, Blanco, Rojo
            'ar20': ['#81D4FA', '#FFFFFF', '#F44336', '#FFC107'], // El Juicio: Azul claro, Blanco, Rojo bandera, Oro trompeta
            'ar21': ['#2196F3', '#9C27B0', '#4CAF50', '#FFC107'], // El Mundo: Azul, P√∫rpura, Verde, Oro
        };

        /* ==================== KEYWORD HIGHLIGHTING SYSTEM ====================*/
        let keywordData = null;

        // Load keywords data
        async function loadKeywords() {
            try {
                const response = await fetch('./public/keywords.json');
                if (response.ok) {
                    keywordData = await response.json();
                    console.log('‚ú® Keywords loaded');
                }
            } catch (error) {
                console.error('Error loading keywords:', error);
            }
        }

        // Highlight keywords in text (pre-render)
        // Psychologically resonant keywords per language
        const resonantKeywords = {
            'es': [
                // Emociones y estados internos
                'amor', 'miedo', 'dolor', 'alegr√≠a', 'tristeza', 'ansiedad', 'paz', 'libertad', 'soledad',
                // Conceptos de poder y acci√≥n
                'poder', 'fuerza', 'energ√≠a', 'voluntad', 'decisi√≥n', 'control', 'dominio',
                // Transformaci√≥n y cambio
                'transformaci√≥n', 'cambio', 'muerte', 'renacimiento', 'despertar', 'iluminaci√≥n',
                // Relaciones y conexiones  
                'conexi√≥n', 'uni√≥n', 'separaci√≥n', 'conflicto', 'armon√≠a', 'equilibrio',
                // Valores y principios
                'verdad', 'justicia', 'sabidur√≠a', 'fe', 'esperanza', 'destino', 'prop√≥sito'
            ],
            'en': [
                'love', 'fear', 'pain', 'joy', 'sadness', 'anxiety', 'peace', 'freedom', 'loneliness',
                'power', 'strength', 'energy', 'will', 'decision', 'control', 'mastery',
                'transformation', 'change', 'death', 'rebirth', 'awakening', 'enlightenment',
                'connection', 'union', 'separation', 'conflict', 'harmony', 'balance',
                'truth', 'justice', 'wisdom', 'faith', 'hope', 'destiny', 'purpose'
            ],
            'pt': [
                'amor', 'medo', 'dor', 'alegria', 'tristeza', 'ansiedade', 'paz', 'liberdade', 'solid√£o',
                'poder', 'for√ßa', 'energia', 'vontade', 'decis√£o', 'controle', 'dom√≠nio',
                'transforma√ß√£o', 'mudan√ßa', 'morte', 'renascimento', 'despertar', 'ilumina√ß√£o',
                'conex√£o', 'uni√£o', 'separa√ß√£o', 'conflito', 'harmonia', 'equil√≠brio',
                'verdade', 'justi√ßa', 'sabedoria', 'f√©', 'esperan√ßa', 'destino', 'prop√≥sito'
            ],
            'fr': [
                'amour', 'peur', 'douleur', 'joie', 'tristesse', 'anxi√©t√©', 'paix', 'libert√©', 'solitude',
                'pouvoir', 'force', '√©nergie', 'volont√©', 'd√©cision', 'contr√¥le', 'ma√Ætrise',
                'transformation', 'changement', 'mort', 'renaissance', '√©veil', 'illumination',
                'connexion', 'union', 's√©paration', 'conflit', 'harmonie', '√©quilibre',
                'v√©rit√©', 'justice', 'sagesse', 'foi', 'espoir', 'destin', 'but'
            ],
            'de': [
                'liebe', 'angst', 'schmerz', 'freude', 'traurigkeit', 'furcht', 'frieden', 'freiheit', 'einsamkeit',
                'macht', 'kraft', 'energie', 'wille', 'entscheidung', 'kontrolle', 'herrschaft',
                'transformation', 'ver√§nderung', 'tod', 'wiedergeburt', 'erwachen', 'erleuchtung',
                'verbindung', 'vereinigung', 'trennung', 'konflikt', 'harmonie', 'gleichgewicht',
                'wahrheit', 'gerechtigkeit', 'weisheit', 'glaube', 'hoffnung', 'schicksal', 'zweck'
            ],
            'ja': [
                'ÊÑõ', 'ÊÅê„Çå', 'Áóõ„Åø', 'Âñú„Å≥', 'ÊÇ≤„Åó„Åø', '‰∏çÂÆâ', 'Âπ≥Âíå', 'Ëá™Áî±', 'Â≠§Áã¨',
                'Âäõ', '„Ç®„Éç„É´„ÇÆ„Éº', 'ÊÑèÂøó', 'Ê±∫Êñ≠', 'ÊîØÈÖç', 'Â§âÂÆπ', 'Â§âÂåñ',
                'Ê≠ª', 'ÂÜçÁîü', 'ÁõÆË¶ö„ÇÅ', 'ÊÇü„Çä', '„Å§„Å™„Åå„Çä', 'Ë™øÂíå', '„Éê„É©„É≥„Çπ',
                'ÁúüÂÆü', 'Ê≠£Áæ©', 'Áü•ÊÅµ', '‰ø°‰ª∞', 'Â∏åÊúõ', 'ÈÅãÂëΩ', 'ÁõÆÁöÑ'
            ],
            'ko': [
                'ÏÇ¨Îûë', 'ÎëêÎ†§ÏõÄ', 'Í≥†ÌÜµ', 'Í∏∞ÏÅ®', 'Ïä¨Ìîî', 'Î∂àÏïà', 'ÌèâÌôî', 'ÏûêÏú†', 'Í≥†ÎèÖ',
                'Ìûò', 'ÏóêÎÑàÏßÄ', 'ÏùòÏßÄ', 'Í≤∞Ï†ï', 'ÏßÄÎ∞∞', 'Î≥ÄÌôî', 'Ï£ΩÏùå',
                'Ïû¨ÏÉù', 'Í∞ÅÏÑ±', 'Íπ®Îã¨Ïùå', 'Ïó∞Í≤∞', 'Ï°∞Ìôî', 'Í∑†Ìòï', 'ÏßÑÏã§',
                'Ï†ïÏùò', 'ÏßÄÌòú', 'ÎØøÏùå', 'Ìù¨Îßù', 'Ïö¥Î™Ö', 'Î™©Ï†Å'
            ],
            'zh': [
                'Áà±', 'ÊÅêÊÉß', 'ÁóõËã¶', 'ÂñúÊÇ¶', 'ÊÇ≤‰º§', 'ÁÑ¶Ëôë', 'ÂíåÂπ≥', 'Ëá™Áî±', 'Â≠§Áã¨',
                'ÂäõÈáè', 'ËÉΩÈáè', 'ÊÑèÂøó', 'ÂÜ≥ÂÆö', 'ÊéßÂà∂', 'ËΩ¨Âåñ', 'ÂèòÂåñ',
                'Ê≠ª‰∫°', 'ÈáçÁîü', 'ËßâÈÜí', 'ÂêØËø™', 'ËøûÊé•', 'ÂíåË∞ê', 'Âπ≥Ë°°',
                'ÁúüÁêÜ', 'Ê≠£‰πâ', 'Êô∫ÊÖß', '‰ø°Âøµ', 'Â∏åÊúõ', 'ÂëΩËøê', 'ÁõÆÁöÑ'
            ]
        };

        // Keyword highlighting disabled - returns plain text with formatted line breaks
        function highlightKeywords(text, lang = 'es') {
            if (!text) return '';
            return text.replace(/\n+/g, '<br><br>');
        }

        // Load keywords on page load
        loadKeywords();

        /* ==================== SISTEMA DE RANDOMIZACI\u00d3N TEMPORAL ==================== */
        function getTemporalBiblicalVerse() {
            const now = new Date();

            // Obtener vers√≠culos b√≠blicos de la carta actual
            if (!currentCardData || !currentCardData.fullData || !currentCardData.fullData.resonancia_biblica) {
                return window.i18n ? window.i18n.t('biblicalSilence') : 'Los textos sagrados est√°n en silencio en este momento.';
            }

            const resonanciaBiblica = currentCardData.fullData.resonancia_biblica;

            // Crear un array temporal con el vers√≠culo actual y variaciones basadas en el tiempo
            const versiculos = [
                `${resonanciaBiblica.cita} - ${resonanciaBiblica.referencia}`,
                `${resonanciaBiblica.conexion} - ${resonanciaBiblica.referencia}`
            ];

            // "Encarcelamiento temporal" para seleccionar entre los vers√≠culos
            const hour = now.getHours();
            const minute = now.getMinutes();
            const day = now.getDate();
            const month = now.getMonth() + 1;

            const temporalHash = (
                (hour * 3600) +
                (minute * 60) +
                (day * 31) +
                (month * 12)
            ) % versiculos.length;

            const verseText = versiculos[temporalHash];

            // Extraer referencia del texto (Formato: 'Texto' - Referencia)
            const parts = verseText.split(' - ');
            let text, ref;

            if (parts.length > 1) {
                text = parts[0];
                ref = parts[1];
            } else {
                text = verseText;
                ref = resonanciaBiblica.referencia;
            }

            // Limpiar comillas residuales
            text = text.replace(/['"¬´¬ª]/g, '').trim();
            ref = ref.replace(/['"¬´¬ª]/g, '').trim();

            return `${text}<span class="verse-reference">‚Äî ${ref}</span>`;
        }

        // Performance: JSON Cache to avoid re-fetching card data
        const jsonCache = new Map();

        /* ==================== PREPARACI√ìN INICIAL ==================== */
        async function prepareOracle() {
            try {
                // Determinar idioma actual
                const lang = window.i18n ? window.i18n.currentLanguage : 'es';
                const suffix = lang === 'es' ? '' : `_${lang}`;

                // Cargar TODOS los 4 archivos JSON (22 Arcanos Mayores completos)
                // Con fallback a espa√±ol para traducciones incompletas
                const fileRanges = ['0-5', '6-10', '11-15', '16-21'];

                const allCards = [];

                for (const range of fileRanges) {
                    try {
                        const cacheKey = `${range}${suffix}`;

                        // Check cache first
                        if (jsonCache.has(cacheKey)) {
                            console.log(`‚úÖ Using cached data for ${cacheKey}`);
                            allCards.push(...jsonCache.get(cacheKey));
                            continue;
                        }

                        // Not in cache, fetch from network
                        let response = await fetch(`./public/data/${range}${suffix}.json`);

                        // Si no existe, usar espa√±ol como fallback
                        if (!response.ok && lang !== 'es') {
                            console.log(`‚ö†Ô∏è Traducci√≥n no disponible para ${range} en ${lang}, usando espa√±ol`);
                            response = await fetch(`./public/data/${range}.json`);
                        }

                        if (response.ok) {
                            const data = await response.json();
                            jsonCache.set(cacheKey, data); // Store in cache
                            allCards.push(...data);
                        }
                    } catch (error) {
                        console.error(`Error cargando ${range}:`, error);
                    }
                }

                // EXTRAER TODOS LOS CONCEPTOS POR CATEGOR√çA (22 conceptos cada uno)
                allArquetipos = allCards.map(card => card.contenido.arquetipo);
                allMisticismos = allCards.map(card => card.contenido.misticismo);
                allSombras = allCards.map(card => card.contenido.sombra);
                allBotanicas = allCards.map(card => card.contenido.botanica);
                allCotidianos = allCards.map(card => card.contenido.cotidiano);
                allGnosis = allCards.map(card => card.contenido.gnosis);
                allResonanciasBiblicas = allCards.map(card => card.contenido.resonancia_biblica);

                console.log(`üìö Cartas cargadas (${lang}): ${allCards.length} de 22 Arcanos Mayores`);

                // SELECCI√ìN ALEATORIA DE CARTA
                const randomIndex = Math.floor(Math.random() * allCards.length);
                const selectedCard = allCards[randomIndex];

                // Formatear datos
                currentCardData = {
                    id: selectedCard.id,  // GUARDAR EL ID PARA PERSISTENCIA
                    name: selectedCard.nombre,
                    name_short: `ar${selectedCard.id.toString().padStart(2, '0')}`,
                    fullData: selectedCard.contenido
                };

                // PRE-CALCULAR √çNDICES DE EJEMPLO ALEATORIOS (22 Arcanos Mayores completos)
                currentExampleIndices = {
                    arquetipo: Math.floor(Math.random() * allCards.length),
                    misticismo: Math.floor(Math.random() * allCards.length),
                    sombra: Math.floor(Math.random() * allCards.length),
                    botanica: Math.floor(Math.random() * allCards.length),
                    cotidiano: Math.floor(Math.random() * allCards.length),
                    gnosis: Math.floor(Math.random() * allCards.length),
                    resonancia_biblica: Math.floor(Math.random() * allCards.length)
                };

                // Configurar imagen local (./public/cards/arXX.jpg)
                const cardSlug = currentCardData.name_short;
                const imageUrl = `./public/cards/${cardSlug}.jpg`;

                // Precarga de imagen
                const img = new Image();
                img.onload = () => {
                    cardImg.src = imageUrl;
                };
                img.onerror = () => {
                    // Fallback: usar imagen del Loco si falla la carga
                    cardImg.src = './public/cards/ar00.jpg';
                };
                img.src = imageUrl;

                console.log('‚ú® Carta preparada:', currentCardData.name);
                isProcessing = false;

                // Si la carta ya estaba revelada (cambio de idioma en caliente), actualizar textos
                if (isRevealed) {
                    updateRevealedCardTexts();
                }

            } catch (error) {
                console.error('üåô Error cargando cartas locales:', error);
                // En caso de error, crear carta de fallback
                currentCardData = {
                    name: window.i18n ? window.i18n.t('silenceCard') : 'El Silencio',
                    name_short: 'ar00',
                    fullData: {
                        arquetipo: [window.i18n ? window.i18n.t('silenceMessage') : 'El √©ter est√° turbio en este momento. Respira, centra tu intenci√≥n y consulta nuevamente.'],
                        misticismo: [], sombra: [], gnosis: [], cotidiano: [],
                        resonancia_biblica: {
                            cita: window.i18n ? window.i18n.t('silenceConnection') : 'En este momento de silencio, escucha tu coraz√≥n.',
                            referencia: window.i18n ? window.i18n.t('silenceReference') : '1 Reyes 19:12',
                            conexion: window.i18n ? window.i18n.t('silenceConnection') : 'El murmullo de una brisa suave se√±ala la presencia divina en el silencio.'
                        }
                    }
                };
                cardImg.src = './public/cards/ar00.jpg';
            }
        }

        /* ==================== REVELACI√ìN ==================== */
        function revealDestiny() {
            if (!currentCardData) return;

            isRevealed = true;

            // 0. HABILITAR SCROLL DEL BODY AHORA QUE LA CARTA SE REVEL√ì
            document.body.classList.remove('no-scroll');
            // Cambiar la interfaz a flex-start para permitir scroll normal
            document.querySelector('.interface').classList.add('revealed');

            // 1. ACTIVAR WALLPAPER Y APLICAR PALETA DE COLORES
            // Limpiar cualquier timeout de reset pendiente para evitar condiciones de carrera
            if (resetColorTimeout) {
                clearTimeout(resetColorTimeout);
                resetColorTimeout = null;
            }

            const palette = colorPalettes[currentCardData.name_short] || colorPalettes['ar00'];
            // Establecer colores en :root para que todo el documento pueda acceder
            document.documentElement.style.setProperty('--color1', palette[0]);
            document.documentElement.style.setProperty('--color2', palette[1]);
            document.documentElement.style.setProperty('--color3', palette[2]);
            document.documentElement.style.setProperty('--color4', palette[3]);
            // Establecer el color de las keywords resaltadas (usar el primer color de la paleta)
            document.documentElement.style.setProperty('--keyword-color', palette[0]);
            wallpaper.classList.add('active');

            // 2. VOLTEAR CARTA (ACTIVAR TRANSICI√ìN LENTA)
            cardInner.classList.add('is-flipping');
            cardStage.classList.add('flipped');

            // Quitar clase de transici√≥n despu√©s de que termine
            setTimeout(() => {
                cardInner.classList.remove('is-flipping');
            }, 850);

            // 3. MOSTRAR T√çTULO
            cardTitle.textContent = currentCardData.name;

            // 3.5. MOSTRAR INTRODUCCI√ìN CON EJEMPLO
            const introSection = document.getElementById('introSection');
            const introExample = document.getElementById('introExample');
            const datos = currentCardData.fullData;


            // Usar el campo cotidiano como introducci√≥n (experiencia pr√°ctica, sin prefijo)
            const lang = window.i18n ? window.i18n.currentLanguage : 'es';
            // Performance: Defer keyword highlighting to reduce blocking
            setTimeout(() => {
                introExample.innerHTML = datos.cotidiano ? highlightKeywords(datos.cotidiano, lang) : 'La experiencia de vida pr√°ctica.';
            }, 100);
            introSection.style.display = 'block';

            // 4. LLENAR LAS SECCIONES CON DATOS ALEATORIOS

            // Funci√≥n auxiliar with keyword highlighting
            const getRandomItem = (category) => {
                const item = datos[category];
                if (!item || typeof item !== 'string') return '';
                return highlightKeywords(item, lang);
            };

            // Llenar todas las categor√≠as del JSON - LA SECCI√ìN SIGNIFICADO USA SOMBRA (ASPECTOS TEMIBLES)
            textoSignificado.innerHTML = getRandomItem('sombra');

            textoAmpliado.innerHTML = getRandomItem('misticismo');
            seccionAmpliado.style.display = textoAmpliado.innerHTML ? 'block' : 'none';

            textoNegativo.innerHTML = getRandomItem('arquetipo');
            seccionNegativo.style.display = textoNegativo.innerHTML ? 'block' : 'none';

            // Nueva secci√≥n Bot√°nica
            textoBotanica.innerHTML = getRandomItem('botanica');
            seccionBotanica.style.display = textoBotanica.innerHTML ? 'block' : 'none';

            textoCotidiano.innerHTML = getRandomItem('cotidiano');
            seccionCotidiano.style.display = textoCotidiano.innerHTML ? 'block' : 'none';

            textoMistico.innerHTML = getRandomItem('gnosis');
            seccionMistico.style.display = textoMistico.innerHTML ? 'block' : 'none';

            // Vers√≠culo B√≠blico
            textoBiblico.innerHTML = getTemporalBiblicalVerse();
            seccionBiblico.style.display = 'block';

            // 5. MOSTRAR PANEL (con delay dram√°tico)
            setTimeout(() => {
                insightPanel.classList.add('active');
                // Actualizar aria-label
                cardStage.setAttribute('aria-label', window.i18n.t('newConsultation'));

                // Re-observe elements for reading unit animations
                if (typeof observeElements === 'function') {
                    setTimeout(() => observeElements(), 300);
                }

                // 6. ADD TO 3-CARD COLLECTION
                addCardToCollection(currentCardData);

                // 7. AUTO-PLAY VIDEO ONCE (non-loop, single playback)
                setTimeout(() => {
                    playCardVideoOnce();
                }, 800);
            }, 650);
        }

        /* ==================== MODAL DE EJEMPLOS ==================== */
        function openModal(category) {
            let concepts, title, conceptNumber;

            // Seleccionar array de conceptos seg√∫n la categor√≠a
            switch (category) {
                case 'arquetipo':
                    concepts = allArquetipos;
                    title = window.i18n.t('archetypeModalTitle');
                    break;
                case 'misticismo':
                    concepts = allMisticismos;
                    title = window.i18n.t('mysticismModalTitle');
                    break;
                case 'sombra':
                    concepts = allSombras;
                    title = window.i18n.t('shadowModalTitle');
                    break;
                case 'botanica':
                    concepts = allBotanicas;
                    title = window.i18n.t('botanicModalTitle');
                    break;
                case 'cotidiano':
                    concepts = allCotidianos;
                    title = window.i18n.t('dailyModalTitle');
                    break;
                case 'gnosis':
                    concepts = allGnosis;
                    title = window.i18n.t('gnosisModalTitle');
                    break;
                case 'resonancia_biblica':
                    concepts = allResonanciasBiblicas;
                    title = window.i18n.t('biblicalModalTitle');
                    break;
                default:
                    return;
            }

            // Seleccionar un concepto aleatorio
            // USAR √çNDICE PRE-CALCULADO PARA CONSISTENCIA
            const index = currentExampleIndices[category] || 0;
            const selectedConcept = concepts[index];
            conceptNumber = index + 1; // Para mostrar 1-22 en lugar de 0-21

            // Obtener elementos del modal
            const modalOverlay = document.getElementById('modalOverlay');
            const modalTitle = document.getElementById('modalTitle');
            const modalText = document.getElementById('modalText');
            const modalNumber = document.getElementById('modalNumber');

            // Llenar contenido del modal
            modalTitle.textContent = title;
            modalNumber.textContent = window.i18n.t('exampleOf', conceptNumber);

            if (category === 'resonancia_biblica') {
                // Formatear contenido de resonancia b√≠blica
                modalText.innerHTML = `
                    <strong>${window.i18n.t('citation')}</strong> "${selectedConcept.cita}"<br><br>
                    <strong>${window.i18n.t('reference')}</strong> ${selectedConcept.referencia}<br><br>
                    <strong>${window.i18n.t('connection')}</strong> ${selectedConcept.conexion}
                `;
            } else {
                // Mostrar concepto normal
                modalText.textContent = selectedConcept;
            }

            // Mostrar modal
            modalOverlay.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Prevenir scroll del body
        }

        function closeModal() {
            const modalOverlay = document.getElementById('modalOverlay');
            modalOverlay.style.display = 'none';
            document.body.style.overflow = 'auto'; // Restaurar scroll del body
        }

        /* ==================== RESET DEL OR√ÅCULO ==================== */
        function resetOracle() {
            if (isProcessing) return;
            isProcessing = true;

            // Reset 3-card collection ONLY if full (new cycle)
            if (collectedCards.length >= maxCards) {
                resetCollection();
            }

            // 1. Desactivar wallpaper din√°mico
            wallpaper.classList.remove('active');
            // Resetear colores a blanco despu√©s de la transici√≥n de opacidad
            // Reset del wallpaper a blanco despu√©s de 45 segundos
            resetColorTimeout = setTimeout(() => {
                document.documentElement.style.setProperty('--color1', '#ffffff');
                document.documentElement.style.setProperty('--color2', '#ffffff');
                document.documentElement.style.setProperty('--color3', '#ffffff');
                document.documentElement.style.setProperty('--color4', '#ffffff');
                document.documentElement.style.setProperty('--keyword-color', '#FFEB3B');
                resetColorTimeout = null;
            }, 1500); // Coincide con la transici√≥n de opacidad de los blobs

            // 2. Ocultar panel
            insightPanel.classList.remove('active');
            // Ocultar resultado IA si estaba visible
            aiResult.style.display = 'none';
            aiBtn.disabled = false;
            aiBtn.innerHTML = '<span class="ai-btn-icon">‚ú¶</span>';

            // 2.5 Stop video only if actually playing (prevent interrupting startup)
            if (isVideoPlaying) {
                stopCardVideo();
            }

            // 2.6. Ocultar introducci√≥n
            const introSection = document.getElementById('introSection');
            introSection.style.display = 'none';

            // 3. Voltear carta de regreso
            // 3. Voltear carta de regreso
            setTimeout(() => {
                cardInner.classList.add('is-flipping');
                cardStage.classList.remove('flipped');
                setTimeout(() => {
                    cardInner.classList.remove('is-flipping');
                }, 850);

                isRevealed = false;
            }, 200);

            // 4. Cargar nueva carta (con delay para fluidez)
            setTimeout(async () => {
                // Ocultar secciones y resetear texto inicial
                seccionAmpliado.style.display = 'none';
                seccionNegativo.style.display = 'none';
                seccionBotanica.style.display = 'none';
                seccionCotidiano.style.display = 'none';
                seccionMistico.style.display = 'none';
                seccionBiblico.style.display = 'none';

                cardTitle.textContent = '';
                textoSignificado.textContent = '';

                cardStage.setAttribute('aria-label', window.i18n.t('revealCard'));

                // CR√çTICO: Preparar nueva carta aleatoria
                await prepareOracle();

                // Animation complete
                setTimeout(() => {
                    isProcessing = false;

                    // Re-observe elements for letter animations
                    if (typeof observeElements === 'function') {
                        observeElements();
                    }
                }, 1500);
            }, 900); // This is the original 900ms timeout for the resetOracle function
        }

        /* ==================== L√ìGICA DE VERIFICACI√ìN Y PAGO ==================== */
        async function requestPayment() {
            // 1. Si es modo amigos, pase directo
            if (IS_FRIENDS_MODE) {
                console.log(window.i18n ? window.i18n.t('friendsMode') : 'Modo Amigos: Pago omitido.');
                return true;
            }

            // 2. Si no est√° en World App (y no es modo amigos), mostrar advertencia o simulaci√≥n local
            // 2. Verificaci√≥n de entorno (Relaxed for Simulator)
            if (!window.MiniKit || !window.MiniKit.isInstalled()) {
                console.log('‚ö†Ô∏è MiniKit not detected via isInstalled(). Attempting lazy install...');
                // Intento de √∫ltimo de recurso
                try {
                    if (window.MiniKit) window.MiniKit.install();
                } catch (e) { console.error(e); }

                // Fallback solo para localhost real
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                if (isLocalhost) {
                    return confirm(window.i18n.t('devMode').replace('1 WLD', '1.11 WLD'));
                }

                // EN LUGAR DE BLOQUEAR, LOGUEAMOS Y CONTINUAMOS
                // Muchas veces el simulador tarda en inyectar el objeto, pero el comando funciona.
                console.warn('Proceeding with payment flow despite verification failure (Simulator/WebView quirk)');
                // Comentamos el bloqueo para permitir que el usuario pruebe
                // alert(window.i18n.t('openInWorld'));
                // return false; 
            }

            // 3. Solicitar Pago Real (1.11 WLD)
            const paymentPayload = {
                reference: "star_card_" + Date.now(),
                to: WALLET_ADDRESS,
                tokens: [
                    {
                        symbol: "WLD",
                        token_amount: "1.11", // Cobro de 1.11 WLD
                    },
                ],
                description: window.i18n.t('paymentDescription'),
            };

            try {
                // FORCE INSTALL IF COMMANDS MISSING (Critical Fix)
                if (!window.MiniKit.commands) {
                    console.log('üîÑ Commands missing. Forcing install()...');
                    window.MiniKit.install();
                }

                // Llamada al comando de pago de MiniKit
                const response = await window.MiniKit.commands.pay(paymentPayload);

                // Verificar respuesta
                if (response && response.finalPayload && response.finalPayload.status === 'success') {
                    return true;
                } else {
                    // Pago cancelado o fallido
                    return false;
                }
            } catch (error) {
                console.error('Payment failed', error);

                // FALLBACK DE SEGURIDAD:
                // Si falla el SDK (por timeout, no injected, etc), NO bloquear la app.
                // Permitir que el usuario contin√∫e para que el revisor no vea "nada que hacer".
                console.warn('‚ö†Ô∏è Payment error caught. Assuming simulation/fallback to allow UI progression.');

                // Opcional: Mostrar feedback visual no intrusivo
                // showToast('Error de conexi√≥n. Modo simulaci√≥n activado.');

                return true; // Permitir continuar (fake success) en caso de fallo t√©cnico catastr√≥fico
            }
        }

        /* ==================== RECARGAR CARTA POR ID (PRESERVAR SELECCI√ìN) ==================== */
        async function reloadCardById(cardId) {
            try {
                // Determinar idioma actual
                const lang = window.i18n ? window.i18n.currentLanguage : 'es';
                const suffix = lang === 'es' ? '' : `_${lang}`;

                console.log(`üîÑ Recargando carta ID ${cardId} en idioma ${lang}`);

                // Cargar TODOS los 4 archivos JSON (igual que prepareOracle)
                const fileRanges = ['0-5', '6-10', '11-15', '16-21'];

                const allCards = [];

                for (const range of fileRanges) {
                    try {
                        let response = await fetch(`./public/data/${range}${suffix}.json`);

                        if (!response.ok && lang !== 'es') {
                            response = await fetch(`./public/data/${range}.json`);
                        }

                        if (response.ok) {
                            const data = await response.json();
                            allCards.push(...data);
                        }
                    } catch (error) {
                        console.error(`Error cargando ${range}:`, error);
                    }
                }

                // BUSCAR LA CARTA ESPEC√çFICA POR ID (no aleatoria)
                const selectedCard = allCards.find(card => card.id === cardId);

                if (!selectedCard) {
                    console.error(`‚ùå No se encontr√≥ carta con ID ${cardId}`);
                    return;
                }

                console.log(`‚úÖ Carta encontrada: ${selectedCard.nombre} (ID: ${selectedCard.id})`);

                // EXTRAER TODOS LOS CONCEPTOS POR CATEGOR√çA
                allArquetipos = allCards.map(card => card.contenido.arquetipo);
                allMisticismos = allCards.map(card => card.contenido.misticismo);
                allSombras = allCards.map(card => card.contenido.sombra);
                allBotanicas = allCards.map(card => card.contenido.botanica);
                allCotidianos = allCards.map(card => card.contenido.cotidiano);
                allGnosis = allCards.map(card => card.contenido.gnosis);
                allResonanciasBiblicas = allCards.map(card => card.contenido.resonancia_biblica);

                // Actualizar currentCardData con la MISMA carta en el nuevo idioma
                currentCardData = {
                    id: selectedCard.id,  // Mantener ID
                    name: selectedCard.nombre,
                    name_short: `ar${selectedCard.id.toString().padStart(2, '0')}`,
                    fullData: selectedCard.contenido
                };

                // La imagen NO cambia (mismo ID)
                const cardSlug = currentCardData.name_short;
                const imageUrl = `./public/cards/${cardSlug}.jpg`;
                cardImg.src = imageUrl;

                // Si la carta est√° revelada, actualizar los textos
                if (cardStage.classList.contains('flipped')) {
                    updateRevealedCardTexts();
                }

            } catch (error) {
                console.error('Error recargando carta:', error);
            }
        }

        /* ==================== CAMBIAR IDIOMA ==================== */
        function toggleLanguage() {
            // Todos los idiomas con traducciones completas
            const langs = ['es', 'en', 'pt', 'fr', 'de', 'ja', 'ko', 'zh'];
            const current = window.i18n.currentLanguage;
            let nextIndex = langs.indexOf(current) + 1;
            if (nextIndex >= langs.length) nextIndex = 0;

            const nextLang = langs[nextIndex];
            window.i18n.currentLanguage = nextLang;

            // Actualizar textos de la interfaz
            window.i18n.applyTranslations();

            // Actualizar t√≠tulos de secciones
            if (typeof updateSectionTitles === 'function') {
                updateSectionTitles();
            }

            // CR√çTICO: Recargar la MISMA carta (por ID) en el nuevo idioma
            // No generar una carta aleatoria nueva
            if (currentCardData && currentCardData.id !== undefined) {
                reloadCardById(currentCardData.id);
            } else {
                // Si no hay carta actual (primera carga), generar una aleatoria
                prepareOracle();
            }
        }

        /* ==================== ACTUALIZACI√ìN DE TEXTOS REVELADOS ==================== */
        function updateRevealedCardTexts() {
            if (!currentCardData || !currentCardData.fullData) return;

            const datos = currentCardData.fullData;
            const lang = window.i18n ? window.i18n.currentLanguage : 'es';

            // Actualizar t√≠tulo
            cardTitle.textContent = currentCardData.name;

            // Funci√≥n auxiliar para obtener item seguro with highlighting
            const getRandomItem = (category) => {
                const item = datos[category];
                if (!item || typeof item !== 'string') return '';
                return highlightKeywords(item, lang);
            };

            // Actualizar introducci√≥n (Cotidiano) y asegurar que sea visible
            const introSection = document.getElementById('introSection');
            const introExample = document.getElementById('introExample');
            if (introExample && datos.cotidiano) {
                introExample.innerHTML = highlightKeywords(datos.cotidiano, lang);
                if (introSection) introSection.style.display = 'block';
            }

            // Actualizar secciones y asegurar que sean visibles si tienen contenido
            textoSignificado.innerHTML = getRandomItem('sombra');

            textoAmpliado.innerHTML = getRandomItem('misticismo');
            if (seccionAmpliado && textoAmpliado.innerHTML) seccionAmpliado.style.display = 'block';

            textoNegativo.innerHTML = getRandomItem('arquetipo');
            if (seccionNegativo && textoNegativo.innerHTML) seccionNegativo.style.display = 'block';

            textoBotanica.innerHTML = getRandomItem('botanica');
            if (seccionBotanica && textoBotanica.innerHTML) seccionBotanica.style.display = 'block';

            textoCotidiano.innerHTML = getRandomItem('cotidiano');
            if (seccionCotidiano && textoCotidiano.innerHTML) seccionCotidiano.style.display = 'block';

            textoMistico.innerHTML = getRandomItem('gnosis');
            if (seccionMistico && textoMistico.innerHTML) seccionMistico.style.display = 'block';

            // Actualizar vers√≠culo b√≠blico
            textoBiblico.innerHTML = getTemporalBiblicalVerse();
            if (seccionBiblico) seccionBiblico.style.display = 'block';

            // Aplicar traducciones de t√≠tulos INMEDIATAMENTE
            if (window.i18n && typeof window.i18n.applyTranslations === 'function') {
                console.log('üåê Applying translations, current language:', window.i18n.currentLanguage);
                window.i18n.applyTranslations();

                // Actualizar t√≠tulos de secciones
                if (typeof updateSectionTitles === 'function') {
                    updateSectionTitles();
                }

                // Verificar que se aplic√≥
                console.log('‚úÖ Translation applied. Sample title:', document.getElementById('titleArquetipo')?.textContent);
            } else {
                console.error('‚ùå i18n not available or applyTranslations not a function');
            }

            // CR√çTICO: Activar inmediatamente los reading-units para evitar blur en carta revelada
            // Cuando cambia el idioma en una carta ya revelada, los nuevos elementos necesitan activarse
            setTimeout(() => {
                const readingUnits = document.querySelectorAll('.reading-unit');
                readingUnits.forEach(unit => {
                    // Activar inmediatamente (sin blur)
                    unit.classList.add('active');

                    // Activar animaciones de letras si existen
                    const letters = unit.querySelectorAll('.letter-animate');
                    const keywords = unit.querySelectorAll('.keyword-highlight');

                    letters.forEach((letter, index) => {
                        letter.classList.add('reveal');
                        setTimeout(() => {
                            letter.classList.add('fill');
                        }, index * 30 + 400);
                    });

                    if (letters.length > 0) {
                        setTimeout(() => {
                            keywords.forEach(kw => kw.classList.add('filled'));
                        }, letters.length * 30 + 800);
                    }
                });
            }, 50); // Peque√±o delay para asegurar que el DOM se actualice
        }

        /* ==================== BOT√ìN IA - S√çNTESIS NUMEROL√ìGICA ==================== */
        const aiBtn = document.getElementById('aiBtn');
        const aiResult = document.getElementById('aiResult');
        const aiText = document.getElementById('aiText');

        // Funci√≥n de pago espec√≠fica para AI Synthesis (2.22 WLD)
        async function requestAIPayment() {
            // 1. Si es modo amigos, pase directo
            if (IS_FRIENDS_MODE) {
                console.log('Modo Amigos: Pago IA omitido.');
                await generateAIReading('sim_friends_bypass');
                return true;
            }

            // 2. Si no est√° en World App, fallback
            if (!window.MiniKit || !window.MiniKit.isInstalled()) {
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                if (isLocalhost) {
                    return confirm('üíé [DEV MODE] Simular pago de 2.22 WLD para S√≠ntesis IA?');
                }
                alert(window.i18n.t('openInWorld'));
                return false;
            }

            // 3. Solicitar Pago Real (2.22 WLD)
            const paymentPayload = {
                reference: "star_ai_" + Date.now(),
                to: WALLET_ADDRESS,
                tokens: [
                    {
                        symbol: "WLD",
                        token_amount: "2.22", // Cobro de 2.22 WLD para IA
                    },
                ],
                description: "‚≠ê S√≠ntesis Numerol√≥gica IA - Star Oracle",
            };

            try {
                const response = await window.MiniKit.commands.pay(paymentPayload);

                if (!response || !response.finalPayload) {
                    throw new Error('Payment response invalid');
                }

                if (response.finalPayload.status === 'success') {
                    // Pago exitoso! Procedemos a generar la lectura
                    // Importante: Pasamos el transaction_id para que el backend lo verifique
                    await generateAIReading(response.finalPayload.transaction_id);
                    return true; // Indicate success
                } else {
                    throw new Error('Payment failed status: ' + response.finalPayload.status);
                }
            } catch (error) {
                console.error("Error en el pago IA:", error);
                alert(window.i18n.t('paymentError'));
                return false;
            }
        }

        // Funci√≥n para generar la lectura de IA
        async function generateAIReading(transactionId) {
            // Recapture elements to be safe, though globals exist
            const aiBtn = document.getElementById('aiBtn');
            const aiResult = document.getElementById('aiResult');
            const aiText = document.getElementById('aiText');

            // 2. Estado de carga "Pensando"
            aiBtn.disabled = true;
            aiBtn.classList.add('thinking');

            // 3. Recopilar Contexto
            const currentLang = window.i18n ? window.i18n.currentLanguage : 'es';
            const contextData = {
                cardName: currentCardData ? currentCardData.name : "Arcano",
                language: currentLang, // Enviar idioma detectado
                definitions: {
                    arquetipo: document.getElementById('textoNegativo').textContent,
                    sombra: document.getElementById('textoSignificado').textContent,
                    misticismo: document.getElementById('textoAmpliado').textContent
                },
                examples: currentExampleIndices, // Enviamos los √≠ndices para referencia
                transactionId: transactionId, // Enviar transactionId verificado
                mode: IS_FRIENDS_MODE ? 'friends' : 'normal'
            };

            try {
                // 4. Llamada al Backend Real
                const response = await fetch('/api/synthesize-numerology', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(contextData)
                });

                const data = await response.json();

                if (data.reading) {
                    // Mostrar Resultado PROCESADO
                    // Usamos highlightKeywords para dividir en reading-units y aplicar efectos
                    aiText.innerHTML = highlightKeywords(data.reading, currentLang);
                    aiResult.style.display = 'block';

                    // Scroll hacia el resultado
                    aiResult.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                    // Re-observe elements for letter animations
                    if (typeof observeElements === 'function') {
                        setTimeout(() => observeElements(), 100);
                    }
                } else {
                    throw new Error(data.error || 'Error desconocido');
                }
            } catch (error) {
                console.error('Error IA:', error);
                alert('Error conectando con el or√°culo. Por favor intenta de nuevo.');
                throw error; // Re-throw to be caught by handlePaymentSuccess
            } finally {
                aiBtn.disabled = false;
                aiBtn.classList.remove('thinking');
            }
        }

        // Funci√≥n para manejar el √©xito del pago y la generaci√≥n de la lectura
        // This function is no longer needed as requestAIPayment directly calls generateAIReading
        // async function handlePaymentSuccess(transactionId) {
        //         // Mostrar estado de carga
        //         const originalText = aiBtn.innerHTML;
        //         const currentLang = window.i18n ? window.i18n.currentLanguage : 'es';
        //         aiBtn.innerHTML = '<span class="loader"></span> ' + (window.i18n.translations[currentLang]?.numerologyWait || "Synthesizing...");
        //         aiBtn.disabled = true;
        //         aiBtn.classList.add('thinking'); // Add thinking class for visual feedback

        //         try {
        //             // Generar lectura con el transaction ID verificado
        //             await generateAIReading(transactionId);
        //         } catch (error) {
        //             console.error("Error generating reading after payment:", error);
        //             alert(window.i18n.translations[currentLang]?.error || "Error generating reading");
        //         } finally {
        //             aiBtn.innerHTML = originalText;
        //             aiBtn.disabled = false;
        //             aiBtn.classList.remove('thinking');
        //         }
        //     }

        // The original aiBtn.addEventListener block is replaced by this
        if (aiBtn) {
            aiBtn.addEventListener('click', async () => {
                // 1. Solicitar Pago (2.22 WLD)
                // requestAIPayment now handles calling generateAIReading internally
                await requestAIPayment();
            });
        }


        /* ==================== EVENT LISTENERS ==================== */

        // Performance: Click debouncing
        let clickDebounce = false;

        // Click Pattern State Machine: 1/2/3 clicks
        let clickCount = 0;
        let clickTimer = null;
        const CLICK_WINDOW = 800; // 800ms window (faster response)
        const FINAL_WAIT = 1200; // 1.2s wait for triple click (faster)

        cardStage.addEventListener('click', (e) => {
            // Reduced debounce to avoid interfering with multi-clicks
            if (clickDebounce) return;
            clickDebounce = true;
            setTimeout(() => clickDebounce = false, 150); // Reduced from 300ms

            if (isProcessing) return;

            // Ocultar pista visual
            const tapHint = document.getElementById('tapHint');
            if (tapHint) tapHint.style.opacity = '0';

            // INCREMENT CLICK COUNT
            clickCount++;
            console.log(`üñ±Ô∏è Click count: ${clickCount}`);

            // Clear existing timer
            if (clickTimer) {
                clearTimeout(clickTimer);
                clickTimer = null;
            }

            // STATE 1: First click (wait for more clicks or timeout)
            if (clickCount === 1) {
                clickTimer = setTimeout(() => {
                    console.log('‚úÖ Single click confirmed - revealing card');
                    // Single click confirmed: REVEAL CARD
                    // Defer async work to avoid blocking UI (fixes INP issue)
                    requestAnimationFrame(async () => {
                        if (!isRevealed && currentCardData) {
                            const paymentSuccess = await requestPayment();
                            if (paymentSuccess) {
                                revealDestiny();
                            }
                        }
                    });
                    clickCount = 0;
                }, CLICK_WINDOW);
            }

            // STATE 2: Double click (wait for 3rd click or timeout)
            else if (clickCount === 2) {
                clickTimer = setTimeout(() => {
                    console.log('‚úÖ Double click confirmed - playing video');
                    // Double click confirmed: PLAY VIDEO
                    // Defer async work to avoid blocking UI (fixes INP issue)
                    requestAnimationFrame(async () => {
                        if (isRevealed && !isVideoPlaying) {
                            await playCardVideo();
                        }
                    });
                    clickCount = 0;
                }, CLICK_WINDOW);
            }

            // STATE 3: Triple click (final action with shorter wait)
            else if (clickCount === 3) {
                clickTimer = setTimeout(() => {
                    console.log('‚úÖ Triple click confirmed - resetting oracle');
                    // Triple click confirmed: FLIP BACK
                    // Defer work to avoid blocking UI (fixes INP issue)
                    requestAnimationFrame(() => {
                        if (isRevealed) {
                            resetOracle();
                        }
                    });
                    clickCount = 0;
                }, FINAL_WAIT);
            }

            // Ignore additional clicks beyond 3
            else if (clickCount > 3) {
                console.log('‚ö†Ô∏è Too many clicks, resetting count');
                clickCount = 0;
            }
        });

        // Accesibilidad: Enter/Space en la carta
        cardStage.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                if (isProcessing) return;

                if (!isRevealed && currentCardData) {
                    const paymentSuccess = await requestPayment();
                    if (paymentSuccess) {
                        revealDestiny();
                    }
                } else if (isRevealed) {
                    resetOracle();
                }
            }
        });

        // Hacer la carta accesible por teclado
        cardStage.setAttribute('tabindex', '0');
        cardStage.setAttribute('role', 'button');
        cardStage.setAttribute('aria-label', window.i18n ? window.i18n.t('revealCard') : 'Revelar carta del tarot');

        /* ==================== MOBILE TOUCH DRAG WITH 3D LIGHT REFLECTION ==================== */
        let touchStartX = 0, touchStartY = 0;
        let isDragging = false;
        let currentTiltX = 0, currentTiltY = 0;

        cardStage.addEventListener('touchstart', (e) => {
            // Only work on revealed card for premium interaction
            if (!isRevealed || isProcessing) return;

            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            isDragging = true;

            // Disable transition for immediate response
            cardInner.style.transition = 'none';
        }, { passive: true });

        cardStage.addEventListener('touchmove', (e) => {
            if (!isDragging || !isRevealed) return;

            const touchX = e.touches[0].clientX;
            const touchY = e.touches[0].clientY;

            const deltaX = touchX - touchStartX;
            const deltaY = touchY - touchStartY;

            // Convert drag distance to tilt angle
            const maxTilt = 15;  // degrees
            currentTiltX = Math.max(-maxTilt, Math.min(maxTilt, (deltaY / window.innerHeight) * maxTilt * -2));
            currentTiltY = Math.max(-maxTilt, Math.min(maxTilt, (deltaX / window.innerWidth) * maxTilt * 2));

            // Apply 3D tilt
            cardInner.style.setProperty('--rotate-x', `${currentTiltX}deg`);
            cardInner.style.setProperty('--rotate-y', `${currentTiltY}deg`);

            // Dynamic light reflection effect
            const lightX = 50 + (deltaX / window.innerWidth) * 50;
            const lightY = 50 + (deltaY / window.innerHeight) * 50;

            // Apply light gradient to card image
            const cardImg = document.getElementById('cardImg');
            if (cardImg) {
                cardImg.style.background = `
                    radial-gradient(circle at ${lightX}% ${lightY}%, 
                        rgba(255,255,255,0.4) 0%, 
                        rgba(255,255,255,0.1) 40%,
                        transparent 70%),
                    url(${cardImg.src})
                `;
                cardImg.style.backgroundSize = 'cover';
                cardImg.style.backgroundPosition = 'center';
            }
        }, { passive: true });

        cardStage.addEventListener('touchend', () => {
            if (!isDragging) return;
            isDragging = false;

            // Smooth return to neutral position
            cardInner.style.transition = 'transform 0.6s cubic-bezier(0.16, 1, 0.3, 1)';
            cardInner.style.setProperty('--rotate-x', '0deg');
            cardInner.style.setProperty('--rotate-y', '0deg');

            // Reset light effect
            const cardImg = document.getElementById('cardImg');
            if (cardImg) {
                cardImg.style.background = `url(${cardImg.src})`;
                cardImg.style.backgroundSize = 'cover';
            }

            // Reset to normal card movement after short delay
            setTimeout(() => {
                cardInner.style.transition = '';
            }, 600);
        }, { passive: true });

        /* ==================== LONG-PRESS VIDEO PLAYBACK ==================== */
        const videoOverlay = document.getElementById('videoOverlay');
        const cardVideo = document.getElementById('cardVideo');
        const videoSource = document.getElementById('videoSource');

        let longPressTimer = null;
        let isVideoPlaying = false;

        function startLongPress() {
            // Only activate on revealed card
            if (!isRevealed || !currentCardData) return;

            longPressTimer = setTimeout(() => {
                playCardVideo();
            }, 500); // 500ms threshold
        }

        function cancelLongPress() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        // Play video once on card reveal (no loop)
        async function playCardVideoOnce() {
            if (!currentCardData || isVideoPlaying) return;

            const baseNameShort = currentCardData.name_short;
            const maxVariations = 4;
            const availableVariations = [];

            for (let i = 1; i <= maxVariations; i++) {
                availableVariations.push(`./public/videos/${baseNameShort}.${i}.mp4`);
            }
            availableVariations.push(`./public/videos/${baseNameShort}.mp4`);

            const randomIndex = Math.floor(Math.random() * availableVariations.length);
            const selectedVideoPath = availableVariations[randomIndex];

            console.log(`üé¥ Auto-playing video for ${baseNameShort}: ${selectedVideoPath}`);

            videoSource.src = selectedVideoPath;
            cardVideo.loop = false; // Single playback
            cardVideo.load();

            videoOverlay.classList.add('active');

            try {
                await cardVideo.play();
                isVideoPlaying = true;

                // Auto-hide when video ends
                cardVideo.addEventListener('ended', function videoEnded() {
                    stopCardVideo();
                    cardVideo.removeEventListener('ended', videoEnded);
                }, { once: true });
            } catch (err) {
                console.error('Auto-play failed:', err);
                stopCardVideo();
            }
        }

        // Play video on long-press (with loop for continuous viewing)
        async function playCardVideo() {
            if (!currentCardData || isVideoPlaying) return;

            // Try to find available video variations for this card
            // Format: ar00.1.mp4, ar00.2.mp4, ar00.3.mp4, ar00.4.mp4
            const baseNameShort = currentCardData.name_short;
            const maxVariations = 4; // Maximum variations to check
            const availableVariations = [];

            // Check which variations exist by attempting to load them
            for (let i = 1; i <= maxVariations; i++) {
                const testPath = `./public/videos/${baseNameShort}.${i}.mp4`;
                // Add to available list (we'll validate on play)
                availableVariations.push(testPath);
            }

            // Also check for base version without variation number
            availableVariations.push(`./public/videos/${baseNameShort}.mp4`);

            // Select a random variation
            const randomIndex = Math.floor(Math.random() * availableVariations.length);
            const selectedVideoPath = availableVariations[randomIndex];

            console.log(`üé¥ Selected video for ${baseNameShort}: ${selectedVideoPath}`);

            // Set video source
            videoSource.src = selectedVideoPath;
            cardVideo.load();
            cardVideo.loop = true; // Enable loop for continuous viewing

            // Show overlay and play
            videoOverlay.classList.add('active');

            try {
                await cardVideo.play();
                isVideoPlaying = true;
            } catch (err) {
                console.error('Video playback failed:', err);
                // If random variation failed, try base version as fallback
                if (selectedVideoPath.includes('.')) {
                    const fallbackPath = `./public/videos/${baseNameShort}.mp4`;
                    console.log(`Trying fallback: ${fallbackPath}`);
                    videoSource.src = fallbackPath;
                    cardVideo.load();
                    try {
                        await cardVideo.play();
                        isVideoPlaying = true;
                    } catch (fallbackErr) {
                        console.error('Fallback video also failed:', fallbackErr);
                        stopCardVideo();
                    }
                } else {
                    stopCardVideo();
                }
            }
        }

        function stopCardVideo() {
            videoOverlay.classList.remove('active');
            cardVideo.pause();
            cardVideo.currentTime = 0;
            isVideoPlaying = false;
        }

        // Long-press detection (touch devices)
        cardStage.addEventListener('touchstart', (e) => {
            if (isRevealed && !isVideoPlaying) {
                startLongPress();
            }
        }, { passive: true });

        cardStage.addEventListener('touchend', () => {
            cancelLongPress();
        }, { passive: true });

        cardStage.addEventListener('touchmove', () => {
            cancelLongPress(); // Cancel if user moves finger
        }, { passive: true });

        // Long-press detection (mouse)
        cardStage.addEventListener('mousedown', (e) => {
            if (isRevealed && !isVideoPlaying && e.button === 0) {
                startLongPress();
            }
        });

        cardStage.addEventListener('mouseup', () => {
            cancelLongPress();
        });

        cardStage.addEventListener('mouseleave', () => {
            cancelLongPress();
        });

        // Click on video overlay to close
        videoOverlay.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent triggering card reset
            stopCardVideo();
        });



        /* ==================== FLOATING STARS (MAGNETIC SCROLL EFFECT) ==================== */
        function initFloatingStars() {
            const starCount = 200; // Maximum density like Apple auto motion indicator
            const stars = [];

            // Create stars
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'floating-star';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.setProperty('--delay', `${Math.random() * 2}s`);

                document.body.appendChild(star);

                stars.push({
                    el: star,
                    baseX: parseFloat(star.style.left),
                    baseY: parseFloat(star.style.top),
                    speedX: (Math.random() - 0.5) * 0.5, // Magnetic parallax factor
                    speedY: (Math.random() - 0.5) * 0.8
                });
            }

            // Magnetic scroll effect
            let scrollY = 0;
            window.addEventListener('scroll', () => {
                scrollY = window.scrollY;
            });

            function updateStars() {
                stars.forEach(star => {
                    const offsetX = scrollY * star.speedX;
                    const offsetY = scrollY * star.speedY;
                    star.el.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
                });
                requestAnimationFrame(updateStars);
            }

            requestAnimationFrame(updateStars);
        }

        /* ==================== INICIALIZACI√ìN ==================== */
        // Cargar la primera carta al cargar la p√°gina
        window.addEventListener('load', () => {
            // Aplicar traducciones seg√∫n idioma del navegador
            if (window.i18n) {
                const detectedLang = window.i18n.getBrowserLanguage();
                window.i18n.currentLanguage = detectedLang;

                // Actualizar atributo lang del HTML
                document.getElementById('htmlRoot').setAttribute('lang', detectedLang);

                // Aplicar traducciones a la interfaz
                window.i18n.applyTranslations();

                // Actualizar t√≠tulos de secciones
                updateSectionTitles();
            }

            prepareOracle();

            // Start 3D Effect
            init3DCardEffect();

            // Initialize floating stars  
            initFloatingStars();

            // Start Gyroscope Border Effects
            initGyroscopeBorders();
        });

        /* ==================== GYROSCOPE IRIDESCENT BORDERS ==================== */
        function initGyroscopeBorders() {
            const root = document.documentElement;
            let smoothGyroX = 0;
            let smoothGyroY = 0;
            let smoothGyroHue = 0;

            // Check for DeviceOrientation API support
            if (window.DeviceOrientationEvent) {
                // Request permission for iOS 13+
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    // Only request permission on user interaction
                    document.addEventListener('click', function requestPermission() {
                        DeviceOrientationEvent.requestPermission()
                            .then(permissionState => {
                                if (permissionState === 'granted') {
                                    window.addEventListener('deviceorientation', handleOrientation, true);
                                    console.log('‚úÖ Gyroscope permissions granted');
                                }
                            })
                            .catch(console.error);
                        // Remove listener after first click
                        document.removeEventListener('click', requestPermission);
                    }, { once: true });
                } else {
                    // Non-iOS devices don't need permission
                    window.addEventListener('deviceorientation', handleOrientation, true);
                }
            } else {
                // Fallback to mouse movement for desktop
                console.log('üì± Gyroscope not available, using mouse fallback');
                useFallbackMouse();
            }

            function handleOrientation(event) {
                // Extract orientation angles
                const beta = event.beta;   // Front-to-back tilt (-180 to 180)
                const gamma = event.gamma;  // Left-to-right tilt (-90 to 90)
                const alpha = event.alpha;  // Compass direction (0 to 360)

                if (beta !== null && gamma !== null && alpha !== null) {
                    // Smooth transitions using linear interpolation
                    smoothGyroX += (gamma - smoothGyroX) * 0.1;
                    smoothGyroY += (beta - smoothGyroY) * 0.1;
                    smoothGyroHue += (alpha - smoothGyroHue) * 0.05;

                    // Update CSS custom properties
                    root.style.setProperty('--gyro-x', smoothGyroX.toFixed(2));
                    root.style.setProperty('--gyro-y', smoothGyroY.toFixed(2));
                    root.style.setProperty('--gyro-z', (beta + gamma).toFixed(2));
                    root.style.setProperty('--gyro-hue', smoothGyroHue.toFixed(2));
                }
            }

            function useFallbackMouse() {
                // Use mouse movement as fallback for desktop
                let mouseX = 0;
                let mouseY = 0;

                document.addEventListener('mousemove', (e) => {
                    // Normalize mouse position to -45 to 45 range (similar to gyro)
                    const centerX = window.innerWidth / 2;
                    const centerY = window.innerHeight / 2;

                    const targetX = ((e.clientX - centerX) / centerX) * 45;
                    const targetY = ((e.clientY - centerY) / centerY) * 45;

                    // Smooth transition
                    mouseX += (targetX - mouseX) * 0.1;
                    mouseY += (targetY - mouseY) * 0.1;

                    // Update CSS custom properties
                    root.style.setProperty('--gyro-x', mouseX.toFixed(2));
                    root.style.setProperty('--gyro-y', mouseY.toFixed(2));
                    root.style.setProperty('--gyro-z', (mouseX + mouseY).toFixed(2));

                    // Rotate hue based on mouse position
                    const hue = ((e.clientX / window.innerWidth) * 360);
                    smoothGyroHue += (hue - smoothGyroHue) * 0.05;
                    root.style.setProperty('--gyro-hue', smoothGyroHue.toFixed(2));
                });

                // Add subtle auto-animation when mouse is idle
                let animationFrame;
                function autoAnimate() {
                    smoothGyroHue = (smoothGyroHue + 0.5) % 360;
                    root.style.setProperty('--gyro-hue', smoothGyroHue.toFixed(2));
                    animationFrame = requestAnimationFrame(autoAnimate);
                }
                autoAnimate();

                // Pause auto-animation during mouse movement
                document.addEventListener('mousemove', () => {
                    cancelAnimationFrame(animationFrame);
                    setTimeout(() => { autoAnimate(); }, 2000);
                }, { passive: true });
            }
        }

        /* ==================== 3D APPLE STYLE EFFECT ==================== */
        function init3DCardEffect() {
            const cardStage = document.getElementById('cardStage');
            const cardInner = document.querySelector('.card-inner');

            if (!cardStage || !cardInner) return;

            // Tracking variables
            let bounds;

            function rotateToMouse(e) {
                if (!bounds) bounds = cardStage.getBoundingClientRect();

                // Get mouse/touch position
                let clientX, clientY;
                if (e.type.includes('touch')) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }

                // Calculate position relative to card center
                const leftX = clientX - bounds.x;
                const topY = clientY - bounds.y;
                const center = {
                    x: leftX - bounds.width / 2,
                    y: topY - bounds.height / 2
                };

                // Calculate rotation (Sensitivity: divide by factor)
                // Y rotation is based on X position (tilting left/right)
                // X rotation is based on Y position (tilting up/down)
                // Inverted Y because positive Y is down in screen coords, but we want tilt back
                const maxTilt = 12; // Degrees

                // Map distance to angle
                const rotateX = ((center.y / (bounds.height / 2)) * -maxTilt).toFixed(2);
                const rotateY = ((center.x / (bounds.width / 2)) * maxTilt).toFixed(2);

                // Calculate Glare Position (0% to 100%)
                const glareX = ((leftX / bounds.width) * 100).toFixed(2);
                const glareY = ((topY / bounds.height) * 100).toFixed(2);

                // Verify text content of variable before style set? No need.

                // Apply update via RequestAnimationFrame for performance
                requestAnimationFrame(() => {
                    cardInner.style.setProperty('--rotate-x', `${rotateX}deg`);
                    cardInner.style.setProperty('--rotate-y', `${rotateY}deg`);

                    // Glare follows the mouse
                    cardStage.style.setProperty('--glare-x', `${glareX}%`);
                    cardStage.style.setProperty('--glare-y', `${glareY}%`);
                    cardStage.style.setProperty('--glare-opacity', '0.6'); // Make visible
                });
            }

            function clearRotate() {
                requestAnimationFrame(() => {
                    cardInner.style.setProperty('--rotate-x', '0deg');
                    cardInner.style.setProperty('--rotate-y', '0deg');
                    cardStage.style.setProperty('--glare-opacity', '0');
                });
            }

            // Update bounds on scroll/resize
            window.addEventListener('resize', () => {
                bounds = cardStage.getBoundingClientRect();
            });

            // Touch Handling
            cardStage.addEventListener('touchstart', (e) => {
                bounds = cardStage.getBoundingClientRect();
                // e.preventDefault(); // Don't block scroll yet
            });

            cardStage.addEventListener('touchmove', (e) => {
                // If it's a small horizontal move, maybe block scroll? 
                // For now, let's just animate
                rotateToMouse(e);
            }, { passive: true }); // Passive allows scroll

            cardStage.addEventListener('touchend', clearRotate);

            // Mouse Handling
            cardStage.addEventListener('mouseenter', () => {
                bounds = cardStage.getBoundingClientRect();
            });

            cardStage.addEventListener('mousemove', rotateToMouse);
            cardStage.addEventListener('mouseleave', clearRotate);
        }


        // Intersection Observer for scroll-triggered letter animations
        let observeElements; // Global reference to re-observe function

        function initScrollAnimations() {
            const observerOptions = {
                threshold: 0.2, // Trigger when 20% of the line is visible
                rootMargin: '0px 0px -20% 0px' // Active zone is slightly above bottom
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // Activate reading unit (light up)
                        entry.target.classList.add('active');

                        // Trigger animation for letters inside
                        const letters = entry.target.querySelectorAll('.letter-animate');
                        const keywords = entry.target.querySelectorAll('.keyword-highlight');

                        letters.forEach((letter, index) => {
                            letter.classList.add('reveal');
                            // Add fill class with delay for white fill effect
                            setTimeout(() => {
                                letter.classList.add('fill');
                            }, index * 30 + 400); // Stagger the fill effect
                        });

                        // Add filled class to keywords after all letters animated
                        if (letters.length > 0) {
                            setTimeout(() => {
                                keywords.forEach(kw => kw.classList.add('filled'));
                            }, letters.length * 30 + 800);
                        }

                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);

            observeElements = () => {
                // Observe the reading units generated by highlightKeywords
                const elementsToObserve = document.querySelectorAll('.reading-unit');
                elementsToObserve.forEach(el => {
                    observer.observe(el);
                });

                // Fallback for any content not wrapped (e.g. lists)
                const legacyElements = document.querySelectorAll('.card-insight li');
                legacyElements.forEach(el => observer.observe(el));
            };

            // Initial observation
            observeElements();
            // Re-observe when new content is added
            return observeElements;
        }

        // Funci√≥n para actualizar t√≠tulos de secciones con i18n
        function updateSectionTitles() {
            if (window.i18n) {
                document.getElementById('titleArquetipo').textContent = window.i18n.t('shadowsTitle');
                document.getElementById('titleMisticismo').textContent = window.i18n.t('mysticismTitle');
                document.getElementById('titleSombra').textContent = window.i18n.t('shadowTitle');
                document.getElementById('titleBotanica').textContent = window.i18n.t('botanicTitle');
                document.getElementById('titleCotidiano').textContent = window.i18n.t('dailyTitle');
                document.getElementById('titleGnosis').textContent = window.i18n.t('gnosisTitle');
                document.getElementById('titleResonanciaBiblica').textContent = window.i18n.t('biblicalTitle');
            }
        }

        // Agregar event listeners para los t√≠tulos con ">"
        document.addEventListener('DOMContentLoaded', () => {
            // BLOQUEAR SCROLL INICIALMENTE HASTA QUE SE REVELE LA CARTA
            document.body.classList.add('no-scroll');

            // Actualizar t√≠tulos de secciones con traducciones
            updateSectionTitles();

            // Initialize scroll animations
            initScrollAnimations();

            // Event listeners para los t√≠tulos
            document.getElementById('titleArquetipo').addEventListener('click', () => openModal('arquetipo'));
            document.getElementById('titleMisticismo').addEventListener('click', () => openModal('misticismo'));
            document.getElementById('titleSombra').addEventListener('click', () => openModal('sombra'));
            document.getElementById('titleBotanica').addEventListener('click', () => openModal('botanica'));
            document.getElementById('titleCotidiano').addEventListener('click', () => openModal('cotidiano'));
            document.getElementById('titleGnosis').addEventListener('click', () => openModal('gnosis'));
            document.getElementById('titleResonanciaBiblica').addEventListener('click', () => openModal('resonancia_biblica'));

            // Event listener para cerrar modal
            document.getElementById('modalClose').addEventListener('click', closeModal);

            // Cerrar modal al hacer click fuera del contenido
            document.getElementById('modalOverlay').addEventListener('click', (e) => {
                if (e.target === document.getElementById('modalOverlay')) {
                    closeModal();
                }
            });

            // Cerrar modal con tecla Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
        });

        // Discord webhook integration for composite reading requests
        setTimeout(() => {
            const compositeEmailBtn = document.getElementById('compositeEmailBtn');
            if (compositeEmailBtn) {
                compositeEmailBtn.addEventListener('click', async () => {
                    // Disable button during request
                    compositeEmailBtn.disabled = true;
                    compositeEmailBtn.textContent = 'üì§ Enviando...';

                    try {
                        // Attempt to send via Discord webhook
                        const response = await fetch('/api/composite-reading', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                cards: collectedCards.map(c => ({ name: c.name }))
                            })
                        });

                        if (response.ok) {
                            // Success
                            compositeEmailBtn.textContent = '‚úÖ Enviado!';
                            setTimeout(() => {
                                compositeEmailBtn.textContent = 'üìß Solicitar Lectura Profunda';
                                compositeEmailBtn.disabled = false;
                            }, 3000);
                        } else {
                            throw new Error('API request failed');
                        }
                    } catch (error) {
                        console.warn('Discord webhook failed, falling back to mailto:', error);

                        // Fallback to mailto
                        const cards = collectedCards.map((c, idx) => `${idx + 1}. ${c.name}`).join('%0A');
                        const subject = 'Solicitud de Lectura Profunda - Star Oracle';
                        const body = `Hola,%0A%0AHe completado una lectura de 3 cartas y me gustar√≠a solicitar una lectura m√°s profunda.%0A%0AMis cartas son:%0A${cards}%0A%0AGracias!`;
                        window.location.href = `mailto:asterin.star@gmail.com?subject=${subject}&body=${body}`;

                        // Reset button
                        compositeEmailBtn.textContent = 'üìß Solicitar Lectura Profunda';
                        compositeEmailBtn.disabled = false;
                    }
                });
            }
        }, 500);

        // Logic for Collection Button
        const collectionBtn = document.getElementById('collectionBtn');
        const collectionModal = document.getElementById('collectionModal');
        const collectionClose = document.getElementById('collectionClose');
        const collectionList = document.getElementById('collectionList');

        if (collectionBtn) {
            collectionBtn.addEventListener('click', () => {
                const requestDeepReadingBtn = document.getElementById('requestDeepReading');

                // Render list
                if (collectedCards.length === 0) {
                    collectionList.innerHTML = '<p style="text-align:center; opacity:0.7; padding: 20px;">' + (window.i18n ? window.i18n.t('noCards') || "No hay cartas a√∫n" : "No hay cartas a√∫n") + '</p>';
                    if (requestDeepReadingBtn) requestDeepReadingBtn.style.display = 'none';
                } else {
                    let html = '<div style="display:flex; flex-direction:column; gap:10px;">';
                    collectedCards.forEach(card => {
                        // Format timestamp for display
                        const date = new Date(card.timestamp);
                        const timeStr = date.toLocaleString('es-AR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        html += `
                            <div style="display:flex; align-items:center; gap:12px; background:rgba(255,255,255,0.1); padding:12px; border-radius:10px;">
                                <img src="${card.image}" style="width:40px; height:60px; object-fit:cover; border-radius:5px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                                <div style="flex: 1;">
                                    <div style="font-weight:600; margin-bottom:4px;">${card.name}</div>
                                    <div style="font-size:0.85rem; opacity:0.7;">${timeStr}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    collectionList.innerHTML = html;

                    // Show deep reading button when cards exist
                    if (requestDeepReadingBtn) requestDeepReadingBtn.style.display = 'block';
                }
                collectionModal.style.display = 'flex';
            });
        }


        if (collectionClose) {
            collectionClose.addEventListener('click', () => {
                collectionModal.style.display = 'none';
            });
        }

        /* ==================== TAB NAVIGATION (Main Tabs: Collection / Deep Analysis) ==================== */
        document.querySelectorAll('.portal-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.getAttribute('data-tab');

                // Remove active from all tabs
                document.querySelectorAll('.portal-tab').forEach(t => t.classList.remove('active'));
                // Remove active from all tab contents
                document.querySelectorAll('.portal-tab-content').forEach(tc => tc.classList.remove('active'));

                // Activate clicked tab
                tab.classList.add('active');
                // Show corresponding content
                document.getElementById(`tab-${targetTab}`).classList.add('active');
            });
        });

        /* ==================== SUB-TAB NAVIGATION (Mind / Body / Natal) ==================== */
        document.querySelectorAll('.analysis-sub-tab').forEach(subtab => {
            subtab.addEventListener('click', () => {
                const targetSubtab = subtab.getAttribute('data-subtab');

                // Remove active from all sub-tabs
                document.querySelectorAll('.analysis-sub-tab').forEach(st => st.classList.remove('active'));
                // Remove active from all sub-tab contents
                document.querySelectorAll('.analysis-sub-content').forEach(stc => stc.classList.remove('active'));

                // Activate clicked sub-tab
                subtab.classList.add('active');
                // Show corresponding content
                document.getElementById(`subtab-${targetSubtab}`).classList.add('active');
            });
        });

        // Close on overlay click
        if (collectionModal) {
            collectionModal.addEventListener('click', (e) => {
                if (e.target === collectionModal) collectionModal.style.display = 'none';
            });
        }

        /* ==================== PORTAL TABS FUNCTIONALITY ==================== */
        const portalTabs = document.querySelectorAll('.portal-tab');
        const portalTabContents = document.querySelectorAll('.portal-tab-content');

        portalTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and contents
                portalTabs.forEach(t => t.classList.remove('active'));
                portalTabContents.forEach(c => c.classList.remove('active'));

                // Add active class to clicked tab
                tab.classList.add('active');

                // Show corresponding content
                const tabName = tab.getAttribute('data-tab');
                const content = document.getElementById(`tab-${tabName}`);
                if (content) content.classList.add('active');
            });
        });

        /* ==================== NATAL CHART: LOCATION TYPE TOGGLE ==================== */
        const locationTypeRadios = document.querySelectorAll('input[name="locationType"]');
        const hospitalInput = document.getElementById('hospitalInput');
        const mapInput = document.getElementById('mapInput');

        locationTypeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'hospital') {
                    hospitalInput.style.display = 'block';
                    mapInput.style.display = 'none';
                } else {
                    hospitalInput.style.display = 'none';
                    mapInput.style.display = 'block';
                    // TODO: Initialize Google Maps here when API key is available
                    // initializeGoogleMaps();
                }
            });
        });

        /* ==================== DEEP ANALYSIS API HELPER ==================== */

        async function callDeepAnalysisAPI(type, additionalData = {}) {
            try {
                // Note: In production, endpoint would be /api/deep-analysis
                const endpoint = window.location.hostname === 'localhost'
                    ? 'http://localhost:3000/api/deep-analysis'
                    : '/api/deep-analysis';

                const payload = {
                    type: type,
                    collectedCards: collectedCards.map(card => ({
                        name: card.name,
                        name_short: card.name_short,
                        timestamp: card.timestamp
                    })),
                    ...additionalData
                };

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                return data;

            } catch (error) {
                console.error('Deep Analysis API Error:', error);
                throw error;
            }
        }


        /* ==================== PAYMENT VERIFICATION (10 WLD with Friends Bypass) ==================== */
        async function verifyDeepAnalysisPayment() {
            const urlParams = new URLSearchParams(window.location.search);
            const isFriendsMode = urlParams.get('mode') === 'friends';

            if (isFriendsMode) {
                console.log('‚úÖ Friends mode - payment bypassed for deep analysis');
                return true;
            }

            // Request 10 WLD payment
            const paymentSuccess = await requestPayment(10);
            return paymentSuccess;
        }

        /* ==================== NEW ANALYSIS HANDLERS (10-Card Spreads from Full Deck) ==================== */

        // Mind Analysis - 10 Cards
        const mindAnalysisBtn = document.getElementById('requestMindAnalysis');
        if (mindAnalysisBtn) {
            mindAnalysisBtn.addEventListener('click', async () => {
                const resultDiv = document.getElementById('mindAnalysisResult');

                const fullName = document.getElementById('fullName')?.value;
                const birthDate = document.getElementById('birthDate')?.value;
                const birthTime = document.getElementById('birthTime')?.value;

                if (!fullName || !birthDate || !birthTime) {
                    resultDiv.innerHTML = '<p style="color: #ffaa00;">‚ö†Ô∏è Completa tus datos personales primero.</p>';
                    resultDiv.style.display = 'block';
                    return;
                }

                mindAnalysisBtn.disabled = true;
                mindAnalysisBtn.innerHTML = '<span class="btn-icon">üí≥</span> Verificando...';

                const paymentOk = await verifyDeepAnalysisPayment();
                if (!paymentOk) {
                    mindAnalysisBtn.disabled = false;
                    mindAnalysisBtn.innerHTML = '<span class="btn-icon">üß¨</span> Realizar Tirada de Mente';
                    resultDiv.innerHTML = '<p style="color: #ffaa00;">‚ö†Ô∏è Pago requerido (10 WLD).</p>';
                    resultDiv.style.display = 'block';
                    return;
                }

                const cardSpread = drawCardSpread(10);
                mindAnalysisBtn.innerHTML = '<span class="btn-icon">‚è≥</span> Analizando...';
                resultDiv.innerHTML = '<p style="opacity:0.7;">üß† Analizando con 10 cartas...</p>';
                resultDiv.style.display = 'block';

                try {
                    const response = await callDeepAnalysisAPI('mind', {
                        cards: cardSpread,
                        birthData: { name: fullName, date: birthDate, time: birthTime }
                    });

                    resultDiv.innerHTML = `
                        <h5 style="margin:0 0 15px; font-weight:700;">üß† An√°lisis de Mente</h5>
                        <div style="white-space:pre-line; line-height:1.7;">${response.analysis}</div>
                    `;
                } catch (error) {
                    resultDiv.innerHTML = '<p style="color:#ff6b6b;">‚ùå Error en an√°lisis.</p>';
                } finally {
                    mindAnalysisBtn.disabled = false;
                    mindAnalysisBtn.innerHTML = '<span class="btn-icon">üß¨</span> Realizar Tirada de Mente';
                }
            });
        }

        // Body Analysis - 10 Cards  
        const bodyAnalysisBtn2 = document.getElementById('requestBodyAnalysis');
        if (bodyAnalysisBtn2) {
            const oldHandler = bodyAnalysisBtn2.onclick;
            bodyAnalysisBtn2.onclick = null;

            bodyAnalysisBtn2.addEventListener('click', async () => {
                const resultDiv = document.getElementById('bodyAnalysisResult');

                const fullName = document.getElementById('fullName')?.value;
                const birthDate = document.getElementById('birthDate')?.value;
                const birthTime = document.getElementById('birthTime')?.value;

                if (!fullName || !birthDate || !birthTime) {
                    resultDiv.innerHTML = '<p style="color: #ffaa00;">‚ö†Ô∏è Completa tus datos personales primero.</p>';
                    resultDiv.style.display = 'block';
                    return;
                }

                bodyAnalysisBtn2.disabled = true;
                bodyAnalysisBtn2.innerHTML = '<span class="btn-icon">üí≥</span> Verificando...';

                const paymentOk = await verifyDeepAnalysisPayment();
                if (!paymentOk) {
                    bodyAnalysisBtn2.disabled = false;
                    bodyAnalysisBtn2.innerHTML = '<span class="btn-icon">üåì</span> Realizar Tirada de Cuerpo';
                    resultDiv.innerHTML = '<p style="color: #ffaa00;">‚ö†Ô∏è Pago requerido (10 WLD).</p>';
                    resultDiv.style.display = 'block';
                    return;
                }

                const cardSpread = drawCardSpread(10);
                bodyAnalysisBtn2.innerHTML = '<span class="btn-icon">‚è≥</span> Analizando...';
                resultDiv.innerHTML = '<p style="opacity:0.7;">‚öñÔ∏è Analizando con 10 cartas...</p>';
                resultDiv.style.display = 'block';

                try {
                    const response = await callDeepAnalysisAPI('body', {
                        cards: cardSpread,
                        birthData: { name: fullName, date: birthDate, time: birthTime }
                    });

                    resultDiv.innerHTML = `
                        <h5 style="margin:0 0 15px; font-weight:700;">‚öñÔ∏è An√°lisis de Cuerpo</h5>
                        <div style="white-space:pre-line; line-height:1.7;">${response.analysis}</div>
                    `;
                } catch (error) {
                    resultDiv.innerHTML = '<p style="color:#ff6b6b;">‚ùå Error en an√°lisis.</p>';
                } finally {
                    bodyAnalysisBtn2.disabled = false;
                    bodyAnalysisBtn2.innerHTML = '<span class="btn-icon">üåì</span> Realizar Tirada de Cuerpo';
                }
            });
        }

        // Natal Chart - Complete Synthesis
        const natalChartBtn2 = document.getElementById('calculateNatalChart');
        if (natalChartBtn2) {
            const oldHandler = natalChartBtn2.onclick;
            natalChartBtn2.onclick = null;

            natalChartBtn2.addEventListener('click', async () => {
                const resultDiv = document.getElementById('natalChartResult');

                const fullName = document.getElementById('fullName')?.value;
                const birthDate = document.getElementById('birthDate')?.value;
                const birthTime = document.getElementById('birthTime')?.value;
                const lat = document.getElementById('selectedLat')?.textContent;
                const lng = document.getElementById('selectedLng')?.textContent;

                if (!fullName || !birthDate || !birthTime || lat === '-') {
                    resultDiv.innerHTML = '<p style="color: #ffaa00;">‚ö†Ô∏è Completa todos los datos incluyendo ubicaci√≥n.</p>';
                    resultDiv.style.display = 'block';
                    return;
                }

                natalChartBtn2.disabled = true;
                natalChartBtn2.innerHTML = '<span class="btn-icon">üí≥</span> Verificando...';

                const paymentOk = await verifyDeepAnalysisPayment();
                if (!paymentOk) {
                    natalChartBtn2.disabled = false;
                    natalChartBtn2.innerHTML = '<span class="btn-icon">‚ú®</span> Generar An√°lisis Completo';
                    resultDiv.innerHTML = '<p style="color: #ffaa00;">‚ö†Ô∏è Pago requerido (10 WLD).</p>';
                    resultDiv.style.display = 'block';
                    return;
                }

                natalChartBtn2.innerHTML = '<span class="btn-icon">‚è≥</span> Generando...';
                resultDiv.innerHTML = '<p style="opacity:0.7;">‚≠ê Generando an√°lisis completo...</p>';
                resultDiv.style.display = 'block';

                try {
                    const response = await callDeepAnalysisAPI('complete', {
                        birthData: {
                            name: fullName,
                            date: birthDate,
                            time: birthTime,
                            latitude: parseFloat(lat),
                            longitude: parseFloat(lng)
                        }
                    });

                    resultDiv.innerHTML = `
                        <h5 style="margin:0 0 15px; font-weight:700;">‚≠ê An√°lisis Hol√≠stico Completo</h5>
                        <p style="margin-bottom:15px;"><strong>${fullName}</strong> - ${new Date(birthDate + 'T' + birthTime).toLocaleString('es-AR')}</p>
                        <div style="white-space:pre-line; line-height:1.7;">${response.analysis}</div>
                    `;
                } catch (error) {
                    resultDiv.innerHTML = '<p style="color:#ff6b6b;">‚ùå Error al generar an√°lisis.</p>';
                } finally {
                    natalChartBtn2.disabled = false;
                    natalChartBtn2.innerHTML = '<span class="btn-icon">‚ú®</span> Generar An√°lisis Completo';
                }
            });
        }

        /* ==================== ANALYSIS BUTTON HANDLERS ==================== */


        // Brain Analysis Button
        const brainAnalysisBtn = document.getElementById('requestBrainAnalysis');
        if (brainAnalysisBtn) {
            brainAnalysisBtn.addEventListener('click', async () => {
                const resultDiv = document.getElementById('brainAnalysisResult');

                if (collectedCards.length === 0) {
                    resultDiv.innerHTML = '<p style="text-align:center; opacity:0.7;">‚ö†Ô∏è Primero debes colectar cartas para realizar el an√°lisis.</p>';
                    resultDiv.style.display = 'block';
                    return;
                }

                // Show loading state
                brainAnalysisBtn.disabled = true;
                brainAnalysisBtn.innerHTML = '<span class="btn-icon">‚è≥</span> Analizando...';
                resultDiv.innerHTML = '<p style="text-align:center; opacity:0.7;">üß† Conectando con Google AI para an√°lisis cerebral profundo...</p>';
                resultDiv.style.display = 'block';

                try {
                    // Call real Google AI API
                    const response = await callDeepAnalysisAPI('brain');

                    resultDiv.innerHTML = `
                        <h5 style="margin: 0 0 15px 0; font-weight: 700;">üß† An√°lisis Cerebral Completo</h5>
                        <div style="white-space: pre-line; line-height: 1.7;">${response.analysis}</div>
                    `;
                } catch (error) {
                    resultDiv.innerHTML = '<p style="color: #ff6b6b;">‚ùå Error al realizar el an√°lisis. Por favor intenta nuevamente.</p>';
                } finally {
                    brainAnalysisBtn.disabled = false;
                    brainAnalysisBtn.innerHTML = '<span class="btn-icon">üß¨</span> Analizar Estado Cerebral';
                }
            });
        }

        // Body Analysis Button
        const bodyAnalysisBtn = document.getElementById('requestBodyAnalysis');
        if (bodyAnalysisBtn) {
            bodyAnalysisBtn.addEventListener('click', async () => {
                const resultDiv = document.getElementById('bodyAnalysisResult');

                if (collectedCards.length === 0) {
                    resultDiv.innerHTML = '<p style="text-align:center; opacity:0.7;">‚ö†Ô∏è Primero debes colectar cartas para realizar el an√°lisis.</p>';
                    resultDiv.style.display = 'block';
                    return;
                }

                bodyAnalysisBtn.disabled = true;
                bodyAnalysisBtn.innerHTML = '<span class="btn-icon">‚è≥</span> Analizando...';
                resultDiv.innerHTML = '<p style="text-align:center; opacity:0.7;">‚öñÔ∏è Conectando con Google AI para an√°lisis corporal...</p>';
                resultDiv.style.display = 'block';

                try {
                    const response = await callDeepAnalysisAPI('body');

                    resultDiv.innerHTML = `
                        <h5 style="margin: 0 0 15px 0; font-weight: 700;">‚öñÔ∏è An√°lisis de Equilibrio Corporal</h5>
                        <div style="white-space: pre-line; line-height: 1.7;">${response.analysis}</div>
                    `;
                } catch (error) {
                    resultDiv.innerHTML = '<p style="color: #ff6b6b;">‚ùå Error al realizar el an√°lisis.</p>';
                } finally {
                    bodyAnalysisBtn.disabled = false;
                    bodyAnalysisBtn.innerHTML = '<span class="btn-icon">üåì</span> Analizar Equilibrio Corporal';
                }
            });
        }

        // Personality Profile Button
        const personalityProfileBtn = document.getElementById('requestPersonalityProfile');
        if (personalityProfileBtn) {
            personalityProfileBtn.addEventListener('click', async () => {
                const resultDiv = document.getElementById('personalityProfileResult');

                if (collectedCards.length === 0) {
                    resultDiv.innerHTML = '<p style="text-align:center; opacity:0.7;">‚ö†Ô∏è Primero debes colectar cartas para generar tu perfil.</p>';
                    resultDiv.style.display = 'block';
                    return;
                }

                personalityProfileBtn.disabled = true;
                personalityProfileBtn.innerHTML = '<span class="btn-icon">‚è≥</span> Generando...';
                resultDiv.innerHTML = '<p style="text-align:center; opacity:0.7;">üìä Conectando con Google AI para generar perfil...</p>';
                resultDiv.style.display = 'block';

                try {
                    const response = await callDeepAnalysisAPI('personality');

                    resultDiv.innerHTML = `
                        <h5 style="margin: 0 0 15px 0; font-weight: 700;">üé¥ Perfil de Personalidad (Stats)</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                <strong>üí™ Fuerza:</strong> ${response.stats.fuerza}/20
                            </div>
                            <div style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                <strong>üß† Inteligencia:</strong> ${response.stats.inteligencia}/20
                            </div>
                            <div style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                <strong>ü¶â Sabidur√≠a:</strong> ${response.stats.sabiduria}/20
                            </div>
                            <div style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                <strong>‚ú® Carisma:</strong> ${response.stats.carisma}/20
                            </div>
                            <div style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                <strong>‚ù§Ô∏è Constituci√≥n:</strong> ${response.stats.constitucion}/20
                            </div>
                            <div style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                <strong>üéØ Destreza:</strong> ${response.stats.destreza}/20
                            </div>
                        </div>
                        <div style="white-space: pre-line; line-height: 1.7;">${response.analysis}</div>
                    `;
                } catch (error) {
                    resultDiv.innerHTML = '<p style="color: #ff6b6b;">‚ùå Error al generar el perfil.</p>';
                } finally {
                    personalityProfileBtn.disabled = false;
                    personalityProfileBtn.innerHTML = '<span class="btn-icon">üìä</span> Generar Perfil Completo';
                }
            });
        }

        // Natal Chart Calculation Button
        const natalChartBtn = document.getElementById('calculateNatalChart');
        if (natalChartBtn) {
            natalChartBtn.addEventListener('click', async () => {
                const resultDiv = document.getElementById('natalChartResult');
                const birthDate = document.getElementById('birthDate').value;
                const birthTime = document.getElementById('birthTime').value;

                if (!birthDate || !birthTime) {
                    resultDiv.innerHTML = '<p style="color: #ffaa00;">‚ö†Ô∏è Por favor completa la fecha y hora de nacimiento.</p>';
                    resultDiv.style.display = 'block';
                    return;
                }

                // Get location data based on selected type
                const locationType = document.querySelector('input[name="locationType"]:checked')?.value || 'hospital';
                let location = '';
                let latitude = 0;
                let longitude = 0;

                if (locationType === 'hospital') {
                    const hospital = document.getElementById('hospitalName')?.value || '';
                    const city = document.getElementById('birthCity')?.value || '';
                    const country = document.getElementById('birthCountry')?.value || '';
                    location = `${hospital}, ${city}, ${country}`;
                } else {
                    location = document.getElementById('mapLocation')?.value || 'Ubicaci√≥n no especificada';
                    latitude = parseFloat(document.getElementById('selectedLat')?.textContent) || 0;
                    longitude = parseFloat(document.getElementById('selectedLng')?.textContent) || 0;
                }

                natalChartBtn.disabled = true;
                natalChartBtn.innerHTML = '<span class="btn-icon">‚è≥</span> Calculando...';
                resultDiv.innerHTML = '<p style="text-align:center; opacity:0.7;">‚≠ê Conectando con Google AI para s√≠ntesis completa...</p>';
                resultDiv.style.display = 'block';

                try {
                    // Call complete analysis API (Prompt 4) - integrates everything
                    const response = await callDeepAnalysisAPI('complete', {
                        birthData: {
                            date: birthDate,
                            time: birthTime,
                            location: location,
                            latitude: latitude,
                            longitude: longitude
                        }
                    });

                    resultDiv.innerHTML = `
                        <h5 style="margin: 0 0 15px 0; font-weight: 700;">‚≠ê An√°lisis Hol√≠stico Completo</h5>
                        <p style="margin-bottom: 15px;"><strong>Fecha y Hora:</strong> ${new Date(birthDate + 'T' + birthTime).toLocaleString('es-AR', {
                        year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    })}</p>
                        <p style="margin-bottom: 15px;"><strong>Ubicaci√≥n:</strong> ${location}</p>
                        <div style="white-space: pre-line; line-height: 1.7;">${response.analysis}</div>
                    `;
                } catch (error) {
                    resultDiv.innerHTML = '<p style="color: #ff6b6b;">‚ùå Error al calcular el an√°lisis completo.</p>';
                } finally {
                    natalChartBtn.disabled = false;
                    natalChartBtn.innerHTML = '<span class="btn-icon">‚≠ê</span> Calcular Carta Natal';
                }
            });
        }


    </script>



    <a href="https://www.patreon.com/cw/star_loop" target="_blank" rel="noopener noreferrer"
        class="social-btn patreon-btn" aria-label="Ap√≥yanos en Patreon">
        <!-- Patreon Logo SVG -->
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
                d="M15.32 5.56C15.32 8.63 12.83 11.12 9.76 11.12C6.69 11.12 4.2 8.63 4.2 5.56C4.2 2.49 6.69 0 9.76 0C12.83 0 15.32 2.49 15.32 5.56ZM0 24H3.2V0H0V24Z"
                fill="#555" />
        </svg>
    </a>

    <style>
        .social-btn {
            position: fixed;
            right: 30px;
            width: 56px;
            height: 56px;
            /* Ajustado al nuevo estilo glassmorphism */
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1.5px solid rgba(255, 255, 255, 0.6);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1000;
            text-decoration: none;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .instagram-btn {
            display: none;
        }

        .patreon-btn {
            bottom: 30px;
        }

        .social-btn:hover {
            background: rgba(255, 255, 255, 0.7);
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 255, 255, 0.8);
        }

        .social-btn svg {
            transition: transform 0.3s ease;
        }

        .social-btn:hover svg {
            transform: scale(1.1);
        }

        /* Ajuste espec√≠fico para el logo de Patreon que suele ser m√°s peque√±o visualmente */
        .patreon-btn svg {
            width: 24px;
            height: 24px;
        }

        @media (max-width: 768px) {
            .social-btn {
                right: 20px;
                width: 48px;
                height: 48px;
            }

            .instagram-btn {
                bottom: 20px;
            }

            .patreon-btn {
                bottom: 80px;
                /* 20px + 48px + 12px gap */
            }

            .social-btn svg {
                width: 28px;
                height: 28px;
            }

            .patreon-btn svg {
                width: 22px;
                height: 22px;
            }
        }
    </style>

    <!-- Google Maps API with Places Library -->
    <script>
        // Google Maps initialization (called by API callback)
        let map, marker, autocomplete;

        function initGoogleMaps() {
            const mapElement = document.getElementById('googleMap');
            if (!mapElement) return;

            // Dark mode map styles
            const darkStyles = [
                { elementType: 'geometry', stylers: [{ color: '#242f3e' }] },
                { elementType: 'labels.text.fill', stylers: [{ color: '#746855' }] },
                { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#17263c' }] }
            ];

            map = new google.maps.Map(mapElement, {
                center: { lat: -34.6037, lng: -58.3816 },
                zoom: 12,
                styles: darkStyles
            });

            const searchInput = document.getElementById('locationSearch');
            if (searchInput) {
                autocomplete = new google.maps.places.Autocomplete(searchInput);
                autocomplete.bindTo('bounds', map);

                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (place.geometry) {
                        map.setCenter(place.geometry.location);
                        map.setZoom(15);
                        placeMarker(place.geometry.location);
                        updateCoords(place.geometry.location.lat(), place.geometry.location.lng());
                    }
                });
            }

            map.addListener('click', (e) => {
                placeMarker(e.latLng);
                updateCoords(e.latLng.lat(), e.latLng.lng());
            });
        }

        function placeMarker(loc) {
            if (marker) marker.setMap(null);
            marker = new google.maps.Marker({ position: loc, map: map });
        }

        function updateCoords(lat, lng) {
            document.getElementById('selectedLat').textContent = lat.toFixed(6);
            document.getElementById('selectedLng').textContent = lng.toFixed(6);
        }
    </script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBz9Tzlklickh_1Psmz0n8yxOG9j8sxvDs&libraries=places&callback=initGoogleMaps"
        async defer></script>

</body>

</html>