<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <script src="https://cdn.jsdelivr.net/npm/@worldcoin/minikit-js@1.2.0/dist/index.js"></script>

    <style>
        /* --- ESTILOS (CSS) --- */
        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 5vh;
            padding-bottom: 50px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
            color: white;
        }

        .cristal {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
        }

        /* CARTA 3D */
        .escenario-3d {
            width: 85vw;
            max-width: 400px;
            aspect-ratio: 3/5;
            perspective: 1000px;
            position: relative;
            z-index: 10;
            animation: levitar 6s ease-in-out infinite;
        }

        @keyframes levitar {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }

        .carta-tarot {
            width: 100%;
            height: 100%;
            position: relative;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .carta-tarot.girada { transform: rotateY(180deg); }

        .cara {
            position: absolute;
            width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            display: flex; justify-content: center; align-items: center;
            padding: 15px; box-sizing: border-box;
        }

        .cara-frente { transform: rotateY(180deg); }
        .cara-atras { 
            transform: rotateY(0deg); 
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.2));
        }

        .imagen-tarot { width: 100%; height: 100%; object-fit: cover; border-radius: 12px; opacity: 0.95; }
        
        .simbolo-reverso {
            font-size: 80px;
            filter: drop-shadow(0 0 10px gold);
            animation: palpitar 3s infinite;
        }
        @keyframes palpitar {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        /* CAJA DE TEXTO */
        .caja-descripcion {
            width: 85vw; max-width: 400px;
            margin-top: 30px; padding: 25px;
            text-align: center;
            opacity: 0; transform: translateY(20px);
            transition: all 0.5s ease;
            pointer-events: none;
        }
        .caja-descripcion.visible { opacity: 1; transform: translateY(0); pointer-events: all; }

        .titulo-arcano { color: #ffd700; text-transform: uppercase; letter-spacing: 2px; margin: 0 0 15px 0; }
        .etiqueta-categoria {
            display: inline-block; background: rgba(255, 215, 0, 0.15); color: #ffd700;
            padding: 5px 15px; border-radius: 15px; font-size: 0.8rem; font-weight: bold;
            margin-bottom: 15px; border: 1px solid rgba(255, 215, 0, 0.3);
        }
        .texto-arcano { line-height: 1.6; font-size: 1.05rem; color: rgba(255,255,255,0.95); margin: 0; }

        /* FONDO */
        .esfera-flotante {
            position: absolute; width: 80vw; height: 80vw;
            background: radial-gradient(circle, #ffd700, #e94560);
            border-radius: 50%; z-index: -1; top: 15%;
            filter: blur(50px); opacity: 0.4;
            animation: flotar 10s ease-in-out infinite;
        }
        @keyframes flotar {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(20px, -30px); }
        }
    </style>
</head>
<body>

    <div class="esfera-flotante"></div>

    <div class="escenario-3d">
        <div class="carta-tarot" onclick="girar(this)">
            <div class="cara cara-frente cristal">
                <img src="" alt="Cargando..." class="imagen-tarot">
            </div>
            <div class="cara cara-atras cristal">
                <div class="simbolo-reverso">‚ú®</div>
            </div>
        </div>
    </div>

    <div class="caja-descripcion cristal">
        <h2 class="titulo-arcano">...</h2>
        <div id="contenido-dinamico">
            <p>Cargando or√°culo...</p>
        </div>
    </div>

    <script>
        // --- 1. VARIABLES GLOBALES ---
        const archivosDatos = [
            'data/0-4.json',
            'data/5-9.json',
            'data/10-14.json',
            'data/15.21.json'
        ];

        const categoriasNombres = {
            arquetipo: "üß† ARQUETIPO",
            sombra: "üåë SOMBRA",
            misticismo: "‚ú® MISTICISMO",
            escenario_mundano: "üåç VIDA REAL",
            botanica: "üåø BOT√ÅNICA",
            gnosis_praxis: "üßò RITUAL",
            pasaje_sagrado: "üìñ MENSAJE SAGRADO"
        };

        let baseDeDatosTarot = []; // Empieza vac√≠a
        let cartaActual = null;
        let haPagado = false; 

        // Referencias DOM
        const imagenDOM = document.querySelector('.imagen-tarot');
        const cajaTexto = document.querySelector('.caja-descripcion');
        const tituloDOM = document.querySelector('.titulo-arcano');
        const contenidoDOM = document.getElementById('contenido-dinamico');

        // --- 2. INICIALIZACI√ìN SEGURA ---
        async function iniciarApp() {
            // A. Instalar MiniKit (Si existe)
            if (typeof MiniKit !== 'undefined') {
                MiniKit.install();
                console.log("MiniKit instalado.");
            } else {
                console.log("MiniKit no detectado (Modo Navegador).");
            }

            // B. Cargar Datos
            try {
                const promesas = archivosDatos.map(url => fetch(url).then(res => res.json()));
                const resultados = await Promise.all(promesas);
                
                baseDeDatosTarot = resultados.flat();
                baseDeDatosTarot.sort((a, b) => a.id - b.id);
                
                console.log("‚ú® Cartas cargadas:", baseDeDatosTarot.length);
                
                // Preparar primera carta
                prepararNuevaCarta();
                
                tituloDOM.textContent = "OR√ÅCULO";
                contenidoDOM.innerHTML = "<p>Toca la carta para recibir tu mensaje.</p>";

            } catch (error) {
                console.error("Error cargando datos:", error);
                tituloDOM.textContent = "ERROR";
                contenidoDOM.innerHTML = "<p>No se pudieron cargar los datos JSON.</p>";
            }
        }

        // --- 3. INTERACCI√ìN PRINCIPAL ---
        async function girar(elemento) {
            // Si no hay datos, no hacemos nada
            if (baseDeDatosTarot.length === 0) return;

            // CASO A: CERRAR CARTA
            if (elemento.classList.contains('girada')) {
                elemento.classList.remove('girada');
                cajaTexto.classList.remove('visible');
                haPagado = false; // Resetear pago para la pr√≥xima
                setTimeout(() => { prepararNuevaCarta(); }, 800);
                return;
            }

            // CASO B: ABRIR CARTA (COBRAR)
            if (!haPagado) {
                const pagoExitoso = await procesarCobro();
                if (pagoExitoso) {
                    haPagado = true;
                } else {
                    return; // Si cancela, no abre
                }
            }

            // ABRIR
            elemento.classList.add('girada');
            setTimeout(() => { cajaTexto.classList.add('visible'); }, 400);
        }

        // --- 4. PROCESAR PAGO ---
        async function procesarCobro() {
            // Si no est√° MiniKit (est√°s en Chrome), pasa gratis para probar
            if (typeof MiniKit === 'undefined' || !MiniKit.isInstalled()) {
                console.log("Modo Pruebas: Pago simulado.");
                return true; 
            }

            try {
                const res = await MiniKit.commands.pay({
                    reference: "tarot-" + Date.now(),
                    to: "0xa3cdea9fe705bc16dcd9e9170e217b0f1ba5aaf6", // TU BILLETERA
                    tokens: [{
                        symbol: "WLD",
                        token_amount: "1.0"
                    }],
                    description: "Revelaci√≥n de Arcano"
                });

                if (res.final_payload.status === "success") {
                    return true;
                } else {
                    return false;
                }
            } catch (e) {
                console.error("Error pago:", e);
                // En producci√≥n esto deber√≠a ser false
                return true; 
            }
        }

        // --- 5. L√ìGICA 7x7 ---
        function prepararNuevaCarta() {
            const indice = Math.floor(Math.random() * baseDeDatosTarot.length);
            cartaActual = baseDeDatosTarot[indice];

            imagenDOM.src = cartaActual.imagen;
            imagenDOM.alt = cartaActual.nombre;
            tituloDOM.textContent = cartaActual.nombre;

            if (cartaActual.datos) {
                const llaves = Object.keys(cartaActual.datos);
                const categoria = llaves[Math.floor(Math.random() * llaves.length)];
                const listaMensajes = cartaActual.datos[categoria];
                const mensaje = listaMensajes[Math.floor(Math.random() * listaMensajes.length)];
                
                const nombreCat = categoriasNombres[categoria] || categoria.toUpperCase();

                contenidoDOM.innerHTML = `
                    <span class="etiqueta-categoria">${nombreCat}</span>
                    <p class="texto-arcano">${mensaje}</p>
                `;
            } else {
                contenidoDOM.innerHTML = "<p>Definici√≥n en construcci√≥n...</p>";
            }
        }

        // Arrancar
        iniciarApp();

    </script>
</body>
</html>
