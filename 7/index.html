<!DOCTYPE html>
<html lang="es">
<head>
<script>
        // --- 1. INICIALIZAR WORLD MINIKIT ---
        MiniKit.install();

        // --- 2. CONFIGURACI√ìN ---
        const archivosDatos = [
            'data/0-4.json',
            'data/5-9.json',
            'data/10-14.json',
            'data/15.21.json'
        ];

        const categoriasNombres = {
            arquetipo: "üß† ARQUETIPO",
            sombra: "üåë SOMBRA",
            misticismo: "‚ú® MISTICISMO",
            escenario_mundano: "üåç VIDA REAL",
            botanica: "üåø BOT√ÅNICA",
            gnosis_praxis: "üßò RITUAL",
            pasaje_sagrado: "üìñ MENSAJE SAGRADO"
        };

        let baseDeDatosTarot = [];
        let cartaActual = null;
        
        // VARIABLE DE CONTROL DE PAGO
        let haPagado = false; 

        const imagenDOM = document.querySelector('.imagen-tarot');
        const cajaTexto = document.querySelector('.caja-descripcion');
        const tituloDOM = document.querySelector('.titulo-arcano');
        const contenidoDOM = document.getElementById('contenido-dinamico');

        // --- INICIO ---
        async function iniciarApp() {
            try {
                const promesas = archivosDatos.map(url => fetch(url).then(res => res.json()));
                const resultados = await Promise.all(promesas);
                baseDeDatosTarot = resultados.flat();
                baseDeDatosTarot.sort((a, b) => a.id - b.id);
                console.log("‚ú® Cartas cargadas:", baseDeDatosTarot.length);
                
                prepararNuevaCarta();
                
                tituloDOM.textContent = "OR√ÅCULO";
                contenidoDOM.innerHTML = "<p>Toca la carta para recibir tu mensaje.</p>";
            } catch (error) {
                console.error("Error:", error);
                tituloDOM.textContent = "ERROR DE CARGA";
                contenidoDOM.innerHTML = "<p>Verifica que est√°s en un servidor seguro.</p>";
            }
        }

        // --- INTERACCI√ìN CON COBRO ---
        async function girar(elemento) {
            if (baseDeDatosTarot.length === 0) return;

            // CASO A: LA CARTA YA EST√Å ABIERTA (QUEREMOS CERRARLA)
            if (elemento.classList.contains('girada')) {
                // 1. Ocultar
                elemento.classList.remove('girada');
                cajaTexto.classList.remove('visible');
                
                // 2. Resetear el estado de pago para la SIGUIENTE carta
                haPagado = false; 

                // 3. Preparar la nueva carta en secreto
                setTimeout(() => { prepararNuevaCarta(); }, 800);
                return;
            } 

            // CASO B: LA CARTA EST√Å CERRADA (QUEREMOS ABRIRLA) -> ¬°COBRAR!
            if (!haPagado) {
                // Intentamos cobrar
                const pagoExitoso = await procesarCobro();
                
                if (pagoExitoso) {
                    haPagado = true; // Marcamos que ya pag√≥ esta carta
                } else {
                    return; // Si no pag√≥ o cancel√≥, NO hacemos nada (no gira)
                }
            }

            // Si llegamos aqu√≠, es porque pag√≥. REVELAR.
            elemento.classList.add('girada');
            setTimeout(() => { cajaTexto.classList.add('visible'); }, 400);
        }

        // --- FUNCI√ìN DE PAGO WORLD ---
        async function procesarCobro() {
            try {
                // Si no estamos en World App (modo prueba en PC), dejamos pasar
                if (!MiniKit.isInstalled()) {
                    console.log("Modo pruebas: Pase gratis.");
                    return true; 
                }

                const res = await MiniKit.commands.pay({
                    reference: "tarot-" + Date.now(),
                    to: "0xa3cdea9fe705bc16dcd9e9170e217b0f1ba5aaf6", // <--- ¬°PON TU BILLETERA DE WORLD AQU√ç!
                    tokens: [{
                        symbol: "WLD",
                        token_amount: "1.0" // Costo por carta
                    }],
                    description: "Revelaci√≥n de Arcano"
                });

                if (res.final_payload.status === "success") {
                    return true;
                } else {
                    alert("Pago cancelado.");
                    return false;
                }
            } catch (e) {
                console.error("Error en pago", e);
                // En desarrollo local, a veces queremos que pase igual para probar
                // return false; // En producci√≥n pon false
                return true; // En desarrollo pon true
            }
        }

        // --- L√ìGICA 7x7 ---
        function prepararNuevaCarta() {
            const indice = Math.floor(Math.random() * baseDeDatosTarot.length);
            cartaActual = baseDeDatosTarot[indice];

            imagenDOM.src = cartaActual.imagen;
            imagenDOM.alt = cartaActual.nombre;
            tituloDOM.textContent = cartaActual.nombre;

            if (cartaActual.datos) {
                const llaves = Object.keys(cartaActual.datos);
                const categoria = llaves[Math.floor(Math.random() * llaves.length)];
                const listaMensajes = cartaActual.datos[categoria];
                const mensaje = listaMensajes[Math.floor(Math.random() * listaMensajes.length)];
                
                const nombreCat = categoriasNombres[categoria] || categoria.toUpperCase();

                contenidoDOM.innerHTML = `
                    <span class="etiqueta-categoria">${nombreCat}</span>
                    <p class="texto-arcano">${mensaje}</p>
                `;
            } else {
                contenidoDOM.innerHTML = "<p>Definici√≥n en construcci√≥n...</p>";
            }
        }

        iniciarApp();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Star</title>

    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <style>
        /* ... tu CSS ... */
        /* =========================================
           1. ESTILOS GENERALES
           ========================================= */
        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 5vh;
            padding-bottom: 50px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
            color: white;
        }

        /* CLASE MAESTRA CRISTAL */
        .cristal {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
        }

        /* =========================================
           2. CARTA Y ESCENARIO
           ========================================= */
        .escenario-3d {
            width: 85vw;
            max-width: 400px;
            aspect-ratio: 3/5;
            perspective: 1000px;
            position: relative;
            z-index: 10;
            animation: levitar 6s ease-in-out infinite;
        }

        @keyframes levitar {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }

        .carta-tarot {
            width: 100%;
            height: 100%;
            position: relative;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .carta-tarot.girada {
            transform: rotateY(180deg);
        }

        .cara {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            box-sizing: border-box;
        }

        /* FRENTE (Imagen) - Empieza oculta */
        .cara-frente { transform: rotateY(180deg); }

        /* ATR√ÅS (Reverso) - Empieza visible */
        .cara-atras { 
            transform: rotateY(0deg); 
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.2));
        }

        .imagen-tarot {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
            opacity: 0.95;
        }

        .simbolo-reverso {
            font-size: 80px;
            filter: drop-shadow(0 0 10px gold);
            animation: palpitar 3s infinite;
        }
        
        @keyframes palpitar {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        /* =========================================
           3. CAJA DE TEXTO
           ========================================= */
        .caja-descripcion {
            width: 85vw;
            max-width: 400px;
            margin-top: 30px;
            padding: 25px;
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
            pointer-events: none;
        }

        .caja-descripcion.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .titulo-arcano {
            margin: 0 0 15px 0;
            font-size: 1.5rem;
            color: #ffd700;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .etiqueta-categoria {
            display: inline-block;
            background: rgba(255, 215, 0, 0.15);
            color: #ffd700;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .texto-arcano {
            margin: 0;
            line-height: 1.6;
            font-size: 1.05rem;
            color: rgba(255,255,255,0.95);
        }

        /* LUZ DE FONDO */
        .esfera-flotante {
            position: absolute;
            width: 80vw;
            height: 80vw;
            background: radial-gradient(circle, #ffd700, #e94560);
            border-radius: 50%;
            z-index: -1;
            top: 15%;
            filter: blur(50px);
            opacity: 0.4;
            animation: flotar 10s ease-in-out infinite;
        }
        @keyframes flotar {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(20px, -30px); }
        }
    </style>
</head>
<body>

    <div class="esfera-flotante"></div>

    <div class="escenario-3d">
        <div class="carta-tarot" onclick="girar(this)">
            <div class="cara cara-frente cristal">
                <img src="" alt="Cargando..." class="imagen-tarot">
            </div>
            <div class="cara cara-atras cristal">
                <div class="simbolo-reverso">‚ú®</div>
            </div>
        </div>
    </div>

    <div class="caja-descripcion cristal">
        <h2 class="titulo-arcano">...</h2>
        <div id="contenido-dinamico">
            <p>Cargando or√°culo...</p>
        </div>
    </div>

    <script>
        // --- RUTAS RELATIVAS PARA GITHUB ---
        // El c√≥digo buscar√° en la carpeta "data/" que est√° al lado de este archivo.
        const archivosDatos = [
            'data/0-4.json',
            'data/5-9.json',
            'data/10-14.json',
            'data/15.21.json'
        ];

        const categoriasNombres = {
            arquetipo: "üß† ARQUETIPO",
            sombra: "üåë SOMBRA",
            misticismo: "‚ú® MISTICISMO",
            escenario_mundano: "üåç VIDA REAL",
            botanica: "üåø BOT√ÅNICA",
            gnosis_praxis: "üßò RITUAL",
            pasaje_sagrado: "üìñ MENSAJE SAGRADO"
        };

        let baseDeDatosTarot = [];
        let cartaActual = null;

        const imagenDOM = document.querySelector('.imagen-tarot');
        const cajaTexto = document.querySelector('.caja-descripcion');
        const tituloDOM = document.querySelector('.titulo-arcano');
        const contenidoDOM = document.getElementById('contenido-dinamico');

        // --- INICIAR APP ---
        async function iniciarApp() {
            try {
                const promesas = archivosDatos.map(url => fetch(url).then(res => res.json()));
                const resultados = await Promise.all(promesas);
                
                baseDeDatosTarot = resultados.flat();
                baseDeDatosTarot.sort((a, b) => a.id - b.id);
                
                console.log("‚ú® Cartas cargadas:", baseDeDatosTarot.length);
                
                prepararNuevaCarta();
                
                tituloDOM.textContent = "OR√ÅCULO";
                contenidoDOM.innerHTML = "<p>Toca la carta para recibir tu mensaje.</p>";

            } catch (error) {
                console.error("Error:", error);
                tituloDOM.textContent = "ERROR";
                contenidoDOM.innerHTML = "<p>No se pudieron cargar los datos.</p>";
            }
        }

        // --- INTERACCI√ìN ---
        function girar(elemento) {
            if (baseDeDatosTarot.length === 0) return;

            if (elemento.classList.contains('girada')) {
                // OCULTAR
                elemento.classList.remove('girada');
                cajaTexto.classList.remove('visible');
                setTimeout(() => { prepararNuevaCarta(); }, 800);
            } else {
                // REVELAR
                elemento.classList.add('girada');
                setTimeout(() => { cajaTexto.classList.add('visible'); }, 400);
            }
        }

        // --- L√ìGICA 7x7 ---
        function prepararNuevaCarta() {
            const indice = Math.floor(Math.random() * baseDeDatosTarot.length);
            cartaActual = baseDeDatosTarot[indice];

            // Imagen
            imagenDOM.src = cartaActual.imagen;
            imagenDOM.alt = cartaActual.nombre;
            tituloDOM.textContent = cartaActual.nombre;

            // Texto Aleatorio
            if (cartaActual.datos) {
                const llaves = Object.keys(cartaActual.datos);
                const categoria = llaves[Math.floor(Math.random() * llaves.length)];
                const listaMensajes = cartaActual.datos[categoria];
                const mensaje = listaMensajes[Math.floor(Math.random() * listaMensajes.length)];
                
                const nombreCat = categoriasNombres[categoria] || categoria.toUpperCase();

                contenidoDOM.innerHTML = `
                    <span class="etiqueta-categoria">${nombreCat}</span>
                    <p class="texto-arcano">${mensaje}</p>
                `;
            } else {
                // Fallback por si una carta est√° vac√≠a
                contenidoDOM.innerHTML = "<p>Definici√≥n en construcci√≥n...</p>";
            }
        }

        iniciarApp();
    </script>
</body>
</html>
