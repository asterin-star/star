<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antigravity Test - Worldcoin MiniKit</title>
    <!-- 1. Inyecci√≥n del SDK desde CDN oficial v2 -->
    <script src="https://mini-app-sdk.worldcoin.org/minikit.js"></script>
    <!-- 2. Instalaci√≥n defensiva y espera del ready -->
    <script>
        // Wait for SDK to be available before initializing
        (function() {
            async function initMiniKit() {
                if (!window.MiniKit) {
                    console.warn('MiniKit no presente en window');
                    return;
                }
                try {
                    const res = await window.MiniKit.install();
                    console.log('MiniKit install ok', res);
                } catch (e) {
                    console.error('MiniKit install failed', e);
                }
            }
            
            // Try immediately (SDK is loaded synchronously)
            if (window.MiniKit) {
                initMiniKit();
            } else {
                // Fallback: wait a bit and try again
                setTimeout(() => {
                    if (window.MiniKit) {
                        initMiniKit();
                    }
                }, 100);
            }
        })();
    </script>
</head>
<body style="background-color: #000; color: #fff; font-family: monospace; text-align: center; padding-top: 50px;">

    <h1>üì° ANTIGRAVITY TEST</h1>
    <p id="status">Esperando se√±al...</p>
    <button onclick="testConnection()" style="padding: 10px 20px; font-size: 16px; cursor: pointer; background: #fff; color: #000; border: none; border-radius: 4px;">TESTEAR CONEXI√ìN</button>
    
    <div style="margin-top: 20px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto; border: 1px solid #333; padding: 10px;">
        <h3>Logs:</h3>
        <pre id="logs" style="color: #0f0; font-size: 12px; white-space: pre-wrap;"></pre>
    </div>

    <script>
        function log(msg) {
            const logs = document.getElementById('logs');
            logs.innerText += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            console.log(msg);
        }

        // Log inicial del estado de MiniKit
        window.addEventListener('load', () => {
            log('=== VERIFICACI√ìN DE INYECCI√ìN DEL SDK ===');
            log(`typeof MiniKit: ${typeof MiniKit}`);
            
            if (typeof MiniKit !== 'undefined') {
                log(`MiniKit existe en window: ‚úÖ`);
                
                // Verificar isInstalled()
                try {
                    const installed = MiniKit.isInstalled();
                    log(`MiniKit.isInstalled(): ${installed}`);
                } catch (e) {
                    log(`Error al llamar isInstalled(): ${e.message}`);
                }
                
                // Mostrar propiedades disponibles
                const keys = Object.keys(MiniKit);
                log(`Object.keys(MiniKit): [${keys.join(', ')}]`);
                
                // Verificar commands espec√≠ficamente
                if (MiniKit.commands) {
                    log(`MiniKit.commands existe: ‚úÖ`);
                    const commandKeys = Object.keys(MiniKit.commands);
                    log(`Object.keys(MiniKit.commands): [${commandKeys.join(', ')}]`);
                } else {
                    log(`MiniKit.commands NO existe: ‚ùå (problema de inyecci√≥n parcial del simulador)`);
                }
            } else {
                log(`MiniKit NO existe en window: ‚ùå`);
                log('El script no se carg√≥ o no estamos en un entorno compatible');
            }
        });

        async function testConnection() {
            const statusLabel = document.getElementById("status");
            
            // Verificaci√≥n mejorada con tolerancia para el simulador
            if (typeof MiniKit === 'undefined') {
                statusLabel.innerText = "‚ùå ERROR CR√çTICO: MiniKit no carg√≥";
                statusLabel.style.color = "#f00";
                log("‚ùå CR√çTICO: El script de MiniKit no carg√≥.");
                return;
            }
            
            log("‚úÖ MiniKit Object disponible");
            
            // Verificar commands antes de proceder
            if (!MiniKit.commands) {
                statusLabel.innerText = "‚ö†Ô∏è ADVERTENCIA: MiniKit carg√≥ pero commands falta";
                statusLabel.style.color = "#ff0";
                log("‚ö†Ô∏è MiniKit existe pero commands est√° ausente (inyecci√≥n parcial del simulador)");
                log("Intentando reinstalar...");
                
                // Intentar reinstalar (await for proper completion)
                try {
                    await MiniKit.install();
                    log("Reinstalaci√≥n ejecutada. Verificando si commands apareci√≥...");
                    
                    // Peque√±o delay para asegurar que la instalaci√≥n se complete
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    // Verificar de nuevo
                    if (MiniKit.commands) {
                        log("‚úÖ Commands ahora disponible despu√©s de reinstalar");
                        statusLabel.innerText = "‚úÖ CONEXI√ìN EXITOSA: MiniKit Activo (tras reinstalar)";
                        statusLabel.style.color = "#0f0";
                    } else {
                        log("‚ùå Commands sigue ausente despu√©s de reinstalar");
                    }
                } catch (e) {
                    log(`Error al reinstalar: ${e.message}`);
                }
                return;
            }
            
            // Si llegamos aqu√≠, MiniKit y commands est√°n disponibles
            statusLabel.innerText = "‚úÖ CONEXI√ìN EXITOSA: MiniKit y Commands Activos";
            statusLabel.style.color = "#0f0";
            log("‚úÖ MiniKit completamente funcional");
            
            // Informaci√≥n adicional
            try {
                const installed = MiniKit.isInstalled();
                log(`isInstalled() retorna: ${installed}`);
            } catch (e) {
                log(`Error verificando isInstalled(): ${e.message}`);
            }
        }
    </script>
</body>
</html>
